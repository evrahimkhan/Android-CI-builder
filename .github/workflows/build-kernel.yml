name: Android Kernel CI Builder

on:
  workflow_dispatch:
    inputs:
      devicename:
        description: "Device Codename (example: moonstone)"
        required: true
        default: "moonstone"

      defconfig:
        description: "Kernel defconfig (example: vendor/moonstone_defconfig)"
        required: true

      kernel_repo:
        description: "Kernel source repo URL"
        required: true

      kernel_branch:
        description: "Kernel repo branch"
        required: true
        default: "main"

      clang_repo:
        description: "Clang repo URL"
        required: true

      clang_branch:
        description: "Clang branch"
        required: true
        default: "main"

jobs:
  build:
    name: Build Kernel
    runs-on: ubuntu-latest

    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4

      - name: Setup build environment
        run: |
          sudo apt update
          sudo apt install -y \
            bc bison build-essential curl flex git gnupg gperf \
            libncurses-dev libssl-dev libelf-dev lzop \
            python3 python3-pip unzip zip wget

      - name: Clone Kernel Source
        run: |
          git clone --depth=1 \
            -b ${{ inputs.kernel_branch }} \
            ${{ inputs.kernel_repo }} kernel
          
      - name: Clone Clang Toolchain
        run: |
          git clone --depth=1 \
            -b ${{ inputs.clang_branch }} \
            ${{ inputs.clang_repo }} clang

      - name: Build Kernel
        run: |
          export ARCH=arm64
          export SUBARCH=arm64
          export PATH=$PWD/clang/bin:$PATH

          cd kernel

          make O=out ${{ inputs.defconfig }}

          make -j$(nproc) O=out \
            CC=clang \
            CROSS_COMPILE=aarch64-linux-gnu- \
            CROSS_COMPILE_ARM32=arm-linux-gnueabi-

      - name: Upload Kernel Image
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ inputs.devicename }}
          path: |
            kernel/out/arch/arm64/boot/Image
            kernel/out/arch/arm64/boot/Image.gz
            kernel/out/arch/arm64/boot/Image.gz-dtb
