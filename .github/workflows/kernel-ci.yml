name: Android Kernel CI

on:
  workflow_dispatch:
    inputs:
      codename:
        description: "Device codename (example: stone)"
        required: true
        default: "stone"
      defconfig:
        description: "Kernel defconfig"
        required: true
        default: "stone_defconfig"

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            bc bison build-essential ccache curl flex \
            git libssl-dev llvm lld python3 zip unzip

      - name: Setup Proton Clang
        run: |
          git clone --depth=1 https://github.com/kdrag0n/proton-clang clang

      - name: Setup ccache
        run: |
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=10G" >> $GITHUB_ENV

      - name: Kernel build
        run: |
          set -e
          export ARCH=arm64
          export SUBARCH=arm64
          export PATH="$PWD/clang/bin:$PATH"

          mkdir -p out
          make O=out ${{ github.event.inputs.defconfig }}
          make -j$(nproc) O=out \
            CC=clang \
            LD=ld.lld \
            LLVM=1 \
            LLVM_IAS=1

      - name: Prepare AnyKernel3
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3 anykernel
          cp out/arch/arm64/boot/Image anykernel/

          cd anykernel
          sed -i "s/device.name=.*/device.name=${{ github.event.inputs.codename }}/" anykernel.sh
          zip -r9 AnyKernel3-${{ github.event.inputs.codename }}.zip *

      - name: Create boot.img (GKI style)
        run: |
          cp out/arch/arm64/boot/Image boot.img

      - name: Collect logs
        run: |
          cp out/.config build.log || true
          echo "" >> build.log
          make -C kernelversion >> build.log 2>/dev/null || true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.run_number }}
          name: Kernel build ${{ github.run_number }}
          files: |
            anykernel/AnyKernel3-${{ github.event.inputs.codename }}.zip
            boot.img
            build.log
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Telegram Final Result
        if: success()
        run: |
          TG_API="https://api.telegram.org/bot${{ secrets.TG_TOKEN }}"
          CHAT_ID="${{ secrets.TG_CHAT_ID }}"
          REPO="${{ github.repository }}"
          TAG="build-${{ github.run_number }}"

          KERNEL_VER=$(strings out/arch/arm64/boot/Image | grep -m1 "Linux version")
          CLANG_VER=$($PWD/clang/bin/clang --version | head -n1)

          ZIP_URL="https://github.com/$REPO/releases/download/$TAG/AnyKernel3-${{ github.event.inputs.codename }}.zip"
          BOOT_URL="https://github.com/$REPO/releases/download/$TAG/boot.img"
          LOG_URL="https://github.com/$REPO/releases/download/$TAG/build.log"

          TEXT="üöÄ *Kernel build completed*
üì± Device: *${{ github.event.inputs.codename }}*
‚öôÔ∏è Defconfig: *${{ github.event.inputs.defconfig }}*

üêß *Kernel info*
$KERNEL_VER

üß∞ *Compiler*
$CLANG_VER"

          curl -s -X POST "$TG_API/sendMessage" \
            -d chat_id="$CHAT_ID" \
            -d parse_mode=Markdown \
            -d text="$TEXT" \
            -d reply_markup="{
              \"inline_keyboard\": [
                [{\"text\":\"‚¨áÔ∏è Download ZIP\",\"url\":\"$ZIP_URL\"}],
                [{\"text\":\"‚¨áÔ∏è Download boot.img\",\"url\":\"$BOOT_URL\"}],
                [{\"text\":\"‚¨áÔ∏è Download build.log\",\"url\":\"$LOG_URL\"}]
              ]
            }"
