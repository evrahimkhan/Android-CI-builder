name: Android Kernel CI

on:
  workflow_dispatch:
    inputs:
      device:
        description: "Device codename"
        required: true
        default: "stone"

      kernel_repo:
        description: "Kernel source git URL"
        required: true

      kernel_branch:
        description: "Kernel git branch"
        required: true

      defconfig:
        description: "Kernel defconfig"
        required: true
        default: "stone_defconfig"

      kernelsu_next:
        description: "Enable KernelSU-Next (true/false)"
        required: true
        default: "false"

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      ARCH: arm64
      SUBARCH: arm64
      CCACHE_DIR: ~/.ccache
      CCACHE_COMPRESS: 1

    steps:
      - name: Checkout CI repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            git curl bc bison flex \
            build-essential gcc g++ \
            libssl-dev libelf-dev \
            python3 unzip ccache

      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ runner.os }}-${{ inputs.device }}
          restore-keys: |
            ccache-${{ runner.os }}-

      - name: Clone kernel source (correct branch)
        run: |
          git clone --depth=1 \
            -b "${{ inputs.kernel_branch }}" \
            "${{ inputs.kernel_repo }}" kernel

      - name: Setup Proton Clang
        run: |
          git clone --depth=1 https://github.com/kdrag0n/proton-clang clang
          echo "$(pwd)/clang/bin" >> $GITHUB_PATH

      - name: Enable KernelSU-Next
        if: inputs.kernelsu_next == 'true'
        run: |
          cd kernel
          curl -LSs https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh | bash -

      - name: Generate release tag
        run: |
          TAG="${{ inputs.device }}-$(date +%Y%m%d-%H%M)"
          echo "RELEASE_TAG=$TAG" >> $GITHUB_ENV

      - name: Build kernel
        run: |
          set -e
          START=$(date +%s)

          cd kernel

          # ğŸ›  HOST tools (fix relr.dyn / libc issue)
          export HOSTCC=gcc
          export HOSTCXX=g++
          export HOSTLD=ld

          # ğŸ¯ Target tools
          export CC=clang
          export LD=ld.lld
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CROSS_COMPILE_ARM32=arm-linux-gnueabi-

          mkdir -p out
          make O=out ${{ inputs.defconfig }}

          make -j$(nproc) O=out \
            CC=clang LD=ld.lld \
            CROSS_COMPILE=aarch64-linux-gnu- \
            CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
            | tee build.log

          END=$(date +%s)
          echo "BUILD_TIME=$((END - START))" >> $GITHUB_ENV

      - name: Prepare error log
        if: failure()
        run: |
          cd kernel
          tail -n 300 build.log > error.log

      - name: Collect size info
        if: success()
        run: |
          cd kernel/out/arch/arm64/boot
          if [ -f Image.gz-dtb ]; then
            stat -c%s Image.gz-dtb > /tmp/size
          else
            stat -c%s Image > /tmp/size
          fi
          echo "IMG_SIZE=$(cat /tmp/size)" >> $GITHUB_ENV

      - name: Create GitHub Release
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: "Kernel â€¢ ${{ inputs.device }}"
          body: |
            âœ… Device: ${{ inputs.device }}
            ğŸŒ¿ Branch: ${{ inputs.kernel_branch }}
            ğŸ” KernelSU-Next: ${{ inputs.kernelsu_next }}
            â± Build time: ${{ env.BUILD_TIME }}s
            ğŸ“¦ Image size: ${{ env.IMG_SIZE }} bytes
          files: |
            kernel/build.log
            kernel/out/arch/arm64/boot/Image*

      - name: Telegram SUCCESS (build.log)
        if: success()
        run: |
          curl -s -F chat_id="${{ secrets.TG_CHAT_ID }}" \
               -F document=@kernel/build.log \
               -F caption="âœ… Kernel Build SUCCESS

ğŸ“± Device: ${{ inputs.device }}
ğŸŒ¿ Branch: ${{ inputs.kernel_branch }}
ğŸ” KernelSU-Next: ${{ inputs.kernelsu_next }}
â± Build time: ${{ env.BUILD_TIME }}s
ğŸ“¦ Image size: ${{ env.IMG_SIZE }} bytes" \
               https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendDocument

      - name: Telegram FAILURE (error.log)
        if: failure()
        run: |
          curl -s -F chat_id="${{ secrets.TG_CHAT_ID }}" \
               -F document=@kernel/error.log \
               -F caption="âŒ Kernel Build FAILED

ğŸ“± Device: ${{ inputs.device }}
ğŸŒ¿ Branch: ${{ inputs.kernel_branch }}
ğŸ” KernelSU-Next: ${{ inputs.kernelsu_next }}" \
               https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendDocument
