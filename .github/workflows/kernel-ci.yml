name: Android Kernel CI (FAST + Proton)

on:
  workflow_dispatch:
    inputs:
      device:
        description: "Device codename"
        required: true
        default: "stone"
      kernel_source:
        description: "Kernel source git URL"
        required: true
      kernel_branch:
        description: "Kernel branch"
        required: true
        default: "main"
      defconfig:
        description: "Kernel defconfig"
        required: true
      enable_kernelsu_next:
        description: "Enable KernelSU-Next (true/false)"
        required: true
        default: "false"

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ARCH: arm64
      SUBARCH: arm64
      TG_TOKEN: ${{ secrets.TG_TOKEN }}
      TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}

    steps:
      - name: Checkout CI repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            bc bison flex ccache clang lld \
            build-essential git curl zip python3

      - name: Setup ccache
        run: |
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          ccache -M 10G

      - name: Clone Proton Clang
        run: |
          git clone --depth=1 https://github.com/kdrag0n/proton-clang clang
          echo "PATH=$PWD/clang/bin:$PATH" >> $GITHUB_ENV

      - name: Clone kernel source (correct branch)
        run: |
          git clone --depth=1 -b "${{ inputs.kernel_branch }}" \
            "${{ inputs.kernel_source }}" kernel

      - name: KernelSU-Next (optional)
        if: ${{ inputs.enable_kernelsu_next == 'true' }}
        run: |
          cd kernel
          curl -LSs \
            https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh | bash -

      - name: Build kernel
        run: |
          set -e
          cd kernel
          export CC="clang"
          export LD="ld.lld"
          export CROSS_COMPILE=aarch64-linux-gnu-
          mkdir -p out
          make O=out ${{ inputs.defconfig }}
          make -j$(nproc) O=out \
            CC="clang" LD="ld.lld" \
            CROSS_COMPILE=aarch64-linux-gnu- \
            | tee build.log

      - name: Collect kernel info
        run: |
          cd kernel
          IMG=out/arch/arm64/boot/Image
          echo "KERNEL_VER=$(strings vmlinux | grep -m1 'Linux version')" >> info.txt
          echo "CLANG_VER=$(clang --version | head -n1)" >> info.txt
          echo "IMAGE_SIZE=$(du -h $IMG | cut -f1)" >> info.txt

      - name: Prepare AnyKernel3 ZIP
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3 ak3
          cp kernel/out/arch/arm64/boot/Image ak3/
          cd ak3
          zip -r ../AnyKernel3-${{ inputs.device }}.zip *

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ inputs.device }}
          path: |
            kernel/out/arch/arm64/boot/Image
            AnyKernel3-${{ inputs.device }}.zip
            kernel/build.log
            kernel/info.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "${{ inputs.device }}-${{ github.run_number }}"
          name: "Kernel build – ${{ inputs.device }}"
          body: |
            Device: ${{ inputs.device }}
            Branch: ${{ inputs.kernel_branch }}
            KernelSU-Next: ${{ inputs.enable_kernelsu_next }}
          files: |
            kernel/out/arch/arm64/boot/Image
            AnyKernel3-${{ inputs.device }}.zip
            kernel/build.log
            kernel/info.txt

      - name: Telegram SUCCESS (send files)
        if: success()
        run: |
          curl -s -F chat_id="$TG_CHAT_ID" \
               -F document=@AnyKernel3-${{ inputs.device }}.zip \
               -F caption="✅ Kernel build SUCCESS (${{ inputs.device }})" \
               https://api.telegram.org/bot$TG_TOKEN/sendDocument

          curl -s -F chat_id="$TG_CHAT_ID" \
               -F document=@kernel/out/arch/arm64/boot/Image \
               https://api.telegram.org/bot$TG_TOKEN/sendDocument

          curl -s -F chat_id="$TG_CHAT_ID" \
               -F document=@kernel/info.txt \
               https://api.telegram.org/bot$TG_TOKEN/sendDocument

      - name: Telegram FAILURE (send log)
        if: failure()
        run: |
          curl -s -F chat_id="$TG_CHAT_ID" \
               -F document=@kernel/build.log \
               -F caption="❌ Kernel build FAILED (${{ inputs.device }})" \
               https://api.telegram.org/bot$TG_TOKEN/sendDocument
