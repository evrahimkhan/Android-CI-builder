name: Universal Android Kernel CI

on:
  workflow_dispatch:
    inputs:
      codename:
        description: "Device codename (e.g. stone)"
        required: true
      defconfig:
        description: "Kernel defconfig (e.g. stone_defconfig)"
        required: true
      kernel_source:
        description: "Kernel source git URL"
        required: true
      kernel_branch:
        description: "Kernel branch"
        required: true
      kernel_name:
        description: "Kernel display name (optional)"
        required: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout CI repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            git bc bison flex ccache \
            libssl-dev libelf-dev \
            python3 zip

      - name: Clone kernel source
        run: |
          git clone --depth=1 \
            -b ${{ inputs.kernel_branch }} \
            ${{ inputs.kernel_source }} kernel

      - name: Setup Proton Clang
        run: |
          git clone --depth=1 https://github.com/kdrag0n/proton-clang clang
          echo "$PWD/clang/bin" >> $GITHUB_PATH

      - name: Enable ccache
        run: |
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
          echo "USE_CCACHE=1" >> $GITHUB_ENV

      - name: Build kernel
        run: |
          set -o pipefail
          cd kernel

          export ARCH=arm64
          export CC=clang
          export LLVM=1
          export LLVM_IAS=1

          mkdir -p out
          make O=out ${{ inputs.defconfig }}
          make -j$(nproc) O=out

      - name: Detect kernel name
        run: |
          if [ -n "${{ inputs.kernel_name }}" ]; then
            echo "${{ inputs.kernel_name }}" > kernel.info
          elif [ -f kernel/out/include/generated/utsrelease.h ]; then
            grep UTS_RELEASE kernel/out/include/generated/utsrelease.h \
              | cut -d '"' -f2 > kernel.info
          else
            echo "Custom Android Kernel" > kernel.info
          fi

      - name: Build AnyKernel3 ZIP
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3
          cp kernel/out/arch/arm64/boot/Image AnyKernel3/Image
          cp kernel.info AnyKernel3/kernel.info
          cd AnyKernel3
          zip -r9 ../AnyKernel3-${{ inputs.codename }}.zip *

      - name: Upload AnyKernel ZIP
        uses: actions/upload-artifact@v4
        with:
          name: AnyKernel3-${{ inputs.codename }}
          path: AnyKernel3-${{ inputs.codename }}.zip
