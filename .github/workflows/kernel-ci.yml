name: Android Kernel CI

on:
  workflow_dispatch:
    inputs:
      device:
        description: "Device codename (e.g. stone)"
        required: true
      kernel_repo:
        description: "Kernel source git URL"
        required: true
      kernel_branch:
        description: "Kernel branch"
        required: true
      defconfig:
        description: "Kernel defconfig (e.g. stone_defconfig)"
        required: true
      enable_kernelsu:
        description: "Enable KernelSU-Next (true/false)"
        required: false
        default: "false"

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      ARCH: arm64
      SUBARCH: arm64
      CCACHE_DIR: ${{ github.workspace }}/.ccache

    steps:
    - name: Checkout CI repo
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          bc bison build-essential ccache curl flex git \
          libssl-dev libelf-dev lld llvm python3 \
          zip unzip

    - name: Clone Proton Clang
      run: |
        git clone --depth=1 https://github.com/kdrag0n/proton-clang clang

    - name: Clone Kernel Source (with branch)
      run: |
        git clone --depth=1 \
          -b "${{ inputs.kernel_branch }}" \
          "${{ inputs.kernel_repo }}" kernel

    - name: Setup PATH
      run: |
        echo "${{ github.workspace }}/clang/bin" >> $GITHUB_PATH
        echo "/usr/lib/ccache" >> $GITHUB_PATH

    - name: KernelSU-Next (optional)
      if: inputs.enable_kernelsu == 'true'
      run: |
        cd kernel
        curl -LSs \
          https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh | bash -

    - name: Configure kernel
      run: |
        cd kernel
        mkdir -p out
        make O=out ${{ inputs.defconfig }}

        if grep -q CONFIG_COMPAT_VDSO=y out/.config; then
          echo "Disabling vdso32"
          scripts/config --file out/.config \
            -d CONFIG_COMPAT_VDSO \
            -d CONFIG_VDSO32
          make O=out olddefconfig
        fi

    - name: Build kernel
      run: |
        cd kernel
        make -j$(nproc) \
          O=out \
          CC=clang \
          LD=ld.lld \
          LLVM=1 \
          LLVM_IAS=1 \
          Image 2>&1 | tee build.log

    - name: Collect kernel info
      run: |
        cd kernel
        strings out/vmlinux | grep "Linux version" | head -1 > kernel_info.txt
        clang --version | head -1 >> kernel_info.txt

    - name: AnyKernel3 ZIP (Image based)
      run: |
        git clone --depth=1 https://github.com/osm0sis/AnyKernel3 anykernel
        cp kernel/out/arch/arm64/boot/Image anykernel/
        cd anykernel
        zip -r ../AnyKernel-${{ inputs.device }}.zip .

    - name: mkbootimg (AOSP)
      run: |
        git clone --depth=1 \
          https://android.googlesource.com/platform/system/tools/mkbootimg tools/mkbootimg
        python3 tools/mkbootimg/mkbootimg.py \
          --kernel kernel/out/arch/arm64/boot/Image \
          --header_version 3 \
          -o boot.img

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: "${{ inputs.device }}-${{ github.run_number }}"
        name: "Kernel ${{ inputs.device }}"
        files: |
          AnyKernel-${{ inputs.device }}.zip
          boot.img
          kernel/build.log
          kernel/kernel_info.txt

    - name: Telegram SUCCESS
      if: success()
      run: |
        curl -F chat_id=${{ secrets.TG_CHAT_ID }} \
             -F document=@AnyKernel-${{ inputs.device }}.zip \
             https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendDocument

        curl -F chat_id=${{ secrets.TG_CHAT_ID }} \
             -F document=@boot.img \
             https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendDocument

    - name: Telegram FAILURE
      if: failure()
      run: |
        curl -F chat_id=${{ secrets.TG_CHAT_ID }} \
             -F document=@kernel/build.log \
             https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendDocument
