name: Universal Android Kernel CI

on:
  workflow_dispatch:
    inputs:
      codename:
        description: "Device codename"
        required: true
      defconfig:
        description: "Kernel defconfig"
        required: true
      kernel_source:
        description: "Kernel source git URL"
        required: true
      kernel_branch:
        description: "Kernel branch"
        required: true
      kernelsu_next:
        description: "Enable KernelSU-Next (true/false)"
        required: true
        default: "false"

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      TZ: Asia/Dhaka
      TELEGRAM_TOKEN: ${{ secrets.TG_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TG_CHAT_ID }}

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          bc bison build-essential ccache curl flex git \
          libssl-dev python3 unzip zip zstd lld gcc g++

    - name: Setup ccache
      run: |
        echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
        echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
        echo "CCACHE_MAXSIZE=10G" >> $GITHUB_ENV

    - name: Clone Proton Clang
      run: |
        git clone --depth=1 https://github.com/kdrag0n/proton-clang clang

    - name: Clone Kernel Source
      run: |
        git clone --depth=1 -b ${{ inputs.kernel_branch }} \
          ${{ inputs.kernel_source }} kernel

    - name: KernelSU-Next (optional)
      if: inputs.kernelsu_next == 'true'
      run: |
        cd kernel
        curl -LSs https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh | bash -

    - name: Build Kernel
      run: |
        set -o pipefail
        export PATH="$PWD/clang/bin:/usr/lib/ccache:$PATH"

        cd kernel
        export ARCH=arm64
        export CC="ccache clang"
        export HOSTCC=gcc
        export HOSTCXX=g++
        export LD=ld.lld
        export LLVM=1
        export LLVM_IAS=1

        mkdir -p out
        make O=out ${{ inputs.defconfig }}

        # Disable WERROR (universal)
        scripts/config --file out/.config -d CONFIG_WERROR || true

        # vdso32 auto-disable
        if grep -q CONFIG_COMPAT_VDSO=y out/.config; then
          scripts/config --file out/.config \
            -d CONFIG_COMPAT_VDSO \
            -d CONFIG_VDSO32
        fi

        make O=out olddefconfig

        make -j$(nproc) O=out Image 2>&1 | tee build.log

    - name: Detect GKI / Kernel Version
      run: |
        cd kernel/out
        strings Image | grep -m1 "Linux version" | tee ../kernel_version.txt
        if grep -q "android" ../kernel_version.txt; then
          echo "KERNEL_TYPE=GKI" >> $GITHUB_ENV
        else
          echo "KERNEL_TYPE=NON-GKI" >> $GITHUB_ENV
        fi

    - name: mkbootimg (AOSP)
      run: |
        git clone --depth=1 https://android.googlesource.com/platform/system/tools/mkbootimg tools/mkbootimg
        chmod +x tools/mkbootimg/mkbootimg.py

        HEADER_VER=4
        if grep -q "3.18" kernel/kernel_version.txt; then
          HEADER_VER=3
        fi

        python3 tools/mkbootimg/mkbootimg.py \
          --kernel kernel/out/Image \
          --header_version $HEADER_VER \
          --output boot.img

    - name: AnyKernel3 ZIP
      run: |
        git clone --depth=1 https://github.com/osm0sis/AnyKernel3 AnyKernel
        cp boot.img AnyKernel/
        cd AnyKernel
        zip -r9 ../AnyKernel-${{ inputs.codename }}.zip *

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-${{ inputs.codename }}
        path: |
          AnyKernel-${{ inputs.codename }}.zip
          boot.img
          build.log

    - name: Telegram Notify
      if: always()
      run: |
        STATUS="‚ùå Build Failed"
        LOG="error.log"
        if [ -f build.log ]; then
          STATUS="‚úÖ Build Success"
          LOG="build.log"
        fi

        ART_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

        curl -s -X POST https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage \
          -d chat_id=$TELEGRAM_CHAT_ID \
          -d text="$STATUS%0Aüì± Device: ${{ inputs.codename }}%0Aüß† $KERNEL_TYPE%0A‚¨áÔ∏è Downloads:" \
          -d reply_markup="{
            \"inline_keyboard\": [
              [{\"text\":\"üì¶ AnyKernel ZIP\",\"url\":\"$ART_URL\"}],
              [{\"text\":\"üß∑ boot.img\",\"url\":\"$ART_URL\"}],
              [{\"text\":\"üìÑ $LOG\",\"url\":\"$ART_URL\"}]
            ]
          }"
