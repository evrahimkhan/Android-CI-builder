name: Android Kernel CI

on:
  workflow_dispatch:
    inputs:
      codename:
        description: "Device codename (e.g. stone)"
        required: true
      defconfig:
        description: "Kernel defconfig"
        required: true
      kernel_repo:
        description: "Kernel source git URL"
        required: true
      kernel_branch:
        description: "Kernel branch"
        default: "main"
        required: true

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      ARCH: arm64
      SUBARCH: arm64
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      CCACHE_MAXSIZE: 20G

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            git curl bc bison flex build-essential \
            libssl-dev libelf-dev ccache \
            python3 python3-pip lld llvm

      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-${{ github.ref }}
          restore-keys: ccache-

      - name: Clone Proton Clang
        run: |
          git clone --depth=1 https://github.com/kdrag0n/proton-clang clang

      - name: Clone kernel source
        run: |
          git clone --depth=1 \
            -b "${{ github.event.inputs.kernel_branch }}" \
            "${{ github.event.inputs.kernel_repo }}" kernel

      - name: Clone mkbootimg (AOSP)
        run: |
          git clone https://android.googlesource.com/platform/system/tools/mkbootimg tools/mkbootimg

      - name: Build kernel
        run: |
          set -o pipefail
          export PATH="$PWD/clang/bin:$PATH"
          export HOSTCC=gcc
          export HOSTLD=ld
          export CC="ccache clang"
          export LD=ld.lld
          export LLVM=1
          export LLVM_IAS=1

          cd kernel
          mkdir -p out

          make O=out ${{ github.event.inputs.defconfig }}

          # ===== vdso32 auto-disable =====
          if grep -q CONFIG_COMPAT_VDSO=y out/.config; then
            scripts/config --file out/.config \
              -d CONFIG_COMPAT_VDSO \
              -d CONFIG_VDSO32
            make O=out olddefconfig
          fi

          make O=out -j$(nproc) | tee build.log

      - name: Detect kernel type + header
        run: |
          cd kernel

          if grep -q CONFIG_GKI=y out/.config; then
            echo "KERNEL_TYPE=GKI" >> $GITHUB_ENV
          else
            echo "KERNEL_TYPE=Non-GKI" >> $GITHUB_ENV
          fi

          KV=$(strings out/vmlinux | grep "Linux version" | head -n1)
          echo "KERNEL_VERSION=$KV" >> $GITHUB_ENV

          if echo "$KV" | grep -q "Android 12\|Android 13\|Android 14"; then
            echo "BOOT_HEADER=4" >> $GITHUB_ENV
          else
            echo "BOOT_HEADER=3" >> $GITHUB_ENV
          fi

      - name: Build boot.img
        run: |
          cd kernel
          python3 ../tools/mkbootimg/mkbootimg.py \
            --kernel out/arch/arm64/boot/Image \
            --header_version $BOOT_HEADER \
            --output boot.img

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ github.event.inputs.codename }}
          path: |
            kernel/out/arch/arm64/boot/Image
            kernel/boot.img
            kernel/build.log

      - name: Telegram notification
        if: success()
        run: |
          ART_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          MSG="âœ… *Kernel Build Success*
ðŸ“± *${{ github.event.inputs.codename }}*
ðŸ§© *$KERNEL_TYPE*
ðŸ“¦ *Boot Header v$BOOT_HEADER*
ðŸ§  *$KERNEL_VERSION*"

          REPLY_MARKUP=$(cat <<EOF
{
  "inline_keyboard": [
    [
      {
        "text": "â¬‡ï¸ Download Artifacts",
        "url": "$ART_URL"
      }
    ]
  ]
}
EOF
)

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TG_CHAT_ID }}" \
            -d parse_mode=Markdown \
            -d text="$MSG" \
            -d reply_markup="$REPLY_MARKUP"
