name: Android Kernel CI Builder

on:
  workflow_dispatch:
    inputs:
      KERNELSU_NEXT:
        description: "Enable KernelSU-Next"
        required: true
        default: "false"
        type: choice
        options:
          - "true"
          - "false"

      SUSFS:
        description: "Enable SUSFS (KernelSU-Next only)"
        required: true
        default: "false"
        type: choice
        options:
          - "true"
          - "false"

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      ARCH: arm64
      SUBARCH: arm64
      KBUILD_BUILD_USER: CI
      KBUILD_BUILD_HOST: GitHub
      TZ: Asia/Dhaka

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üß∞ Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            git curl bc bison flex libssl-dev \
            build-essential python3 \
            gcc-aarch64-linux-gnu \
            gcc-arm-linux-gnueabi \
            libncurses-dev ccache

      - name: ‚öôÔ∏è Setup toolchain
        run: |
          echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
          echo "CROSS_COMPILE_ARM32=arm-linux-gnueabi-" >> $GITHUB_ENV
          echo "PATH=/usr/lib/ccache:$PATH" >> $GITHUB_ENV

      - name: üîç Kernel version detect
        run: |
          make kernelversion > kernel_version.txt
          echo "KERNEL_VERSION=$(cat kernel_version.txt)" >> $GITHUB_ENV

      - name: üîê KernelSU-Next (optional)
        if: ${{ inputs.KERNELSU_NEXT == 'true' }}
        run: |
          curl -LSs https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh | bash -
          if [ "${{ inputs.SUSFS }}" = "true" ]; then
            echo "CONFIG_KSU_SUSFS=y" >> arch/arm64/configs/vendor_defconfig
          fi

      - name: ‚öôÔ∏è Defconfig
        run: |
          mkdir -p out
          make O=out vendor_defconfig

      - name: üõë Auto disable vdso32 if broken
        run: |
          set -o pipefail
          if grep -q CONFIG_COMPAT_VDSO=y out/.config; then
            echo "‚ö†Ô∏è COMPAT_VDSO detected, disabling vdso32"
            scripts/config --file out/.config \
              -d CONFIG_COMPAT_VDSO \
              -d CONFIG_ARM64_VDSO32
            make O=out olddefconfig
          fi

      - name: üèóÔ∏è Build kernel (Werror fixed)
        run: |
          set -o pipefail
          make -j$(nproc) O=out \
            KCFLAGS=-Wno-error \
            2>&1 | tee build.log

      - name: üì¶ Prepare AnyKernel
        run: |
          git clone https://github.com/osm0sis/AnyKernel3 anykernel
          cp out/arch/arm64/boot/Image anykernel/

      - name: üì¶ Create AnyKernel ZIP
        run: |
          cd anykernel
          zip -r9 ../AnyKernel-${{ env.KERNEL_VERSION }}.zip *
          cd ..

      - name: üì± Build boot.img (mkbootimg)
        run: |
          sudo apt install -y mkbootimg
          mkbootimg \
            --kernel out/arch/arm64/boot/Image \
            --header_version 3 \
            --os_version 13 \
            --os_patch_level 2024-01-01 \
            -o boot.img

      - name: ‚¨ÜÔ∏è Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Kernel-${{ env.KERNEL_VERSION }}
          path: |
            AnyKernel-${{ env.KERNEL_VERSION }}.zip
            boot.img
            build.log

      - name: üì≤ Telegram notify with download button
        if: always()
        run: |
          ARTIFACT_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          TEXT="‚úÖ Kernel Build Finished%0Aüì¶ Version: ${{ env.KERNEL_VERSION }}"
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TG_CHAT_ID }} \
            -d text="$TEXT" \
            -d reply_markup='{
              "inline_keyboard":[
                [{"text":"‚¨áÔ∏è Download Artifacts","url":"'"$ARTIFACT_URL"'"}]
              ]
            }'
