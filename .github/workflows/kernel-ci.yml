name: Android Kernel CI

on:
  workflow_dispatch:
    inputs:
      codename:
        description: "Device codename"
        required: true
        default: "stone"
      defconfig:
        description: "Kernel defconfig"
        required: true
        default: "vendor/stone_defconfig"

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      ARCH: arm64
      SUBARCH: arm64
      CCACHE_DIR: $HOME/.ccache

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt update
          sudo apt install -y \
            bc bison build-essential ccache curl flex git \
            libssl-dev libelf-dev python3 zip unzip wget

      - name: Setup ccache
        run: |
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
          ccache -M 5G

      - name: Clone Proton Clang
        run: |
          git clone --depth=1 https://github.com/kdrag0n/proton-clang clang

      - name: Export toolchain
        run: |
          echo "PATH=$PWD/clang/bin:$PATH" >> $GITHUB_ENV
          echo "CC=clang" >> $GITHUB_ENV
          echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
          echo "CROSS_COMPILE_ARM32=arm-linux-gnueabi-" >> $GITHUB_ENV

      - name: Build kernel
        run: |
          set -o pipefail
          mkdir -p out
          make O=out ${{ github.event.inputs.defconfig }}
          make -j$(nproc) O=out 2>&1 | tee build.log

      - name: Detect GKI
        run: |
          if grep -q "CONFIG_GKI=y" out/.config; then
            echo "KERNEL_TYPE=GKI" >> $GITHUB_ENV
          else
            echo "KERNEL_TYPE=NON-GKI" >> $GITHUB_ENV
          fi

      - name: Extract kernel info
        run: |
          KVER=$(strings out/arch/arm64/boot/Image | grep -m1 "Linux version" || true)
          CLANGV=$(clang --version | head -n1)
          echo "KERNEL_VERSION=$KVER" >> $GITHUB_ENV
          echo "CLANG_VERSION=$CLANGV" >> $GITHUB_ENV

      - name: Build boot.img
        run: |
          git clone https://android.googlesource.com/platform/system/tools/mkbootimg tools/mkbootimg
          python3 tools/mkbootimg/mkbootimg.py \
            --kernel out/arch/arm64/boot/Image \
            --output boot.img

      - name: Build AnyKernel3
        run: |
          git clone https://github.com/osm0sis/AnyKernel3 anykernel
          cp out/arch/arm64/boot/Image anykernel/
          cd anykernel
          zip -r9 ../AnyKernel3-${{ github.event.inputs.codename }}.zip *

      - name: Prepare error log
        if: failure()
        run: |
          echo "Kernel build failed" > error.log
          tail -n 200 build.log >> error.log || true

      - name: GitHub Release
        if: success() || failure()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.run_number }}
          name: Kernel Build ${{ github.run_number }}
          files: |
            AnyKernel3-${{ github.event.inputs.codename }}.zip
            boot.img
            build.log
            error.log
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ================= TELEGRAM SUCCESS =================
      - name: Telegram SUCCESS
        if: success()
        run: |
          TG="https://api.telegram.org/bot${{ secrets.TG_TOKEN }}"
          CHAT="${{ secrets.TG_CHAT_ID }}"
          REPO="${{ github.repository }}"
          TAG="build-${{ github.run_number }}"

          ZIP_URL="https://github.com/$REPO/releases/download/$TAG/AnyKernel3-${{ github.event.inputs.codename }}.zip"
          BOOT_URL="https://github.com/$REPO/releases/download/$TAG/boot.img"
          LOG_URL="https://github.com/$REPO/releases/download/$TAG/build.log"

          cat <<EOF > payload.json
          {
            "chat_id": "$CHAT",
            "text": "‚úÖ Kernel Build Success\n\nüì± Device: ${{ github.event.inputs.codename }}\nüß© Type: $KERNEL_TYPE\n\nüêß $KERNEL_VERSION\nüß∞ $CLANG_VERSION",
            "reply_markup": {
              "inline_keyboard": [
                [{"text":"‚¨áÔ∏è AnyKernel ZIP","url":"$ZIP_URL"}],
                [{"text":"‚¨áÔ∏è boot.img","url":"$BOOT_URL"}],
                [{"text":"‚¨áÔ∏è build.log","url":"$LOG_URL"}]
              ]
            }
          }
          EOF

          curl -s -X POST "$TG/sendMessage" \
            -H "Content-Type: application/json" \
            -d @payload.json

          curl -s -F chat_id="$CHAT" -F document=@AnyKernel3-${{ github.event.inputs.codename }}.zip "$TG/sendDocument"
          curl -s -F chat_id="$CHAT" -F document=@boot.img "$TG/sendDocument"
          curl -s -F chat_id="$CHAT" -F document=@build.log "$TG/sendDocument"

      # ================= TELEGRAM FAILURE =================
      - name: Telegram FAILURE
        if: failure()
        run: |
          TG="https://api.telegram.org/bot${{ secrets.TG_TOKEN }}"
          CHAT="${{ secrets.TG_CHAT_ID }}"
          REPO="${{ github.repository }}"
          TAG="build-${{ github.run_number }}"

          ERR_URL="https://github.com/$REPO/releases/download/$TAG/error.log"

          cat <<EOF > payload.json
          {
            "chat_id": "$CHAT",
            "text": "‚ùå Kernel Build Failed\n\nüì± Device: ${{ github.event.inputs.codename }}\nüß© Type: $KERNEL_TYPE",
            "reply_markup": {
              "inline_keyboard": [
                [{"text":"‚¨áÔ∏è error.log","url":"$ERR_URL"}]
              ]
            }
          }
          EOF

          curl -s -X POST "$TG/sendMessage" \
            -H "Content-Type: application/json" \
            -d @payload.json

          curl -s -F chat_id="$CHAT" -F document=@error.log "$TG/sendDocument"
