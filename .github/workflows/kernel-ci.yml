name: Android Kernel CI

on:
  workflow_dispatch:
    inputs:
      codename:
        description: "Device codename"
        required: true
        default: "stone"

      defconfig:
        description: "Kernel defconfig"
        required: true
        default: "vendor/stone_defconfig"

      kernel_source:
        description: "Kernel source repo URL"
        required: true
        default: "https://github.com/example/android_kernel"

      kernel_branch:
        description: "Kernel branch"
        required: true
        default: "main"

      kernelsu_next:
        description: "Enable KernelSU-Next (true/false)"
        required: true
        default: "false"

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      ARCH: arm64
      SUBARCH: arm64
      CCACHE_DIR: $HOME/.ccache

    steps:
      - name: Checkout kernel source
        run: |
          git clone --depth=1 \
            -b ${{ github.event.inputs.kernel_branch }} \
            ${{ github.event.inputs.kernel_source }} kernel

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            bc bison build-essential ccache curl flex git \
            libssl-dev libelf-dev python3 zip unzip wget

      - name: Setup ccache
        run: |
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
          ccache -M 5G

      - name: Clone Proton Clang
        run: |
          git clone --depth=1 https://github.com/kdrag0n/proton-clang clang

      - name: Export toolchain
        run: |
          echo "PATH=$PWD/clang/bin:$PATH" >> $GITHUB_ENV
          echo "CC=clang" >> $GITHUB_ENV
          echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
          echo "CROSS_COMPILE_ARM32=arm-linux-gnueabi-" >> $GITHUB_ENV

      - name: KernelSU-Next integration
        if: ${{ github.event.inputs.kernelsu_next == 'true' }}
        run: |
          cd kernel
          curl -LSs https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh | bash -

      - name: Build kernel
        run: |
          set -o pipefail
          cd kernel
          mkdir -p out
          make O=out ${{ github.event.inputs.defconfig }}
          make -j$(nproc) O=out 2>&1 | tee ../build.log

      - name: Detect GKI
        run: |
          if grep -q "CONFIG_GKI=y" kernel/out/.config; then
            echo "KERNEL_TYPE=GKI" >> $GITHUB_ENV
          else
            echo "KERNEL_TYPE=NON-GKI" >> $GITHUB_ENV
          fi

      - name: Extract kernel info
        run: |
          KVER=$(strings kernel/out/arch/arm64/boot/Image | grep -m1 "Linux version" || true)
          CLANGV=$(clang --version | head -n1)
          echo "KERNEL_VERSION=$KVER" >> $GITHUB_ENV
          echo "CLANG_VERSION=$CLANGV" >> $GITHUB_ENV

      - name: Build boot.img
        run: |
          git clone https://android.googlesource.com/platform/system/tools/mkbootimg tools/mkbootimg
          python3 tools/mkbootimg/mkbootimg.py \
            --kernel kernel/out/arch/arm64/boot/Image \
            --output boot.img

      - name: Build AnyKernel3 ZIP
        run: |
          git clone https://github.com/osm0sis/AnyKernel3 anykernel
          cp kernel/out/arch/arm64/boot/Image anykernel/
          cd anykernel
          zip -r9 ../AnyKernel3-${{ github.event.inputs.codename }}.zip *

      - name: Prepare error log
        if: failure()
        run: |
          echo "Kernel build failed" > error.log
          tail -n 200 build.log >> error.log || true
