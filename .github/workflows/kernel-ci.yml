name: Android Kernel CI

on:
  workflow_dispatch:
    inputs:
      device:
        description: "Device codename"
        required: true
        default: "stone"

      kernel_source:
        description: "Kernel source URL"
        required: true
        default: ""

      kernel_branch:
        description: "Kernel branch"
        required: true
        default: "main"

      defconfig:
        description: "Kernel defconfig"
        required: true
        default: "stone_defconfig"

      kernelsu_next:
        description: "Enable KernelSU-Next"
        required: true
        default: "false"

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      TG_TOKEN: ${{ secrets.TG_TOKEN }}
      TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}

    steps:
      - name: Checkout CI repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            bc bison build-essential curl flex git \
            libssl-dev libelf-dev python3 zip unzip

      - name: Clone kernel source
        run: |
          git clone --depth=1 \
            -b "${{ inputs.kernel_branch }}" \
            "${{ inputs.kernel_source }}" kernel

      - name: Setup KernelSU-Next
        if: ${{ inputs.kernelsu_next == 'true' }}
        run: |
          cd kernel
          curl -LSs https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh | bash -

      - name: Setup Clang
        run: |
          git clone --depth=1 https://github.com/llvm/llvm-project clang
          echo "$(pwd)/clang/bin" >> $GITHUB_PATH

      - name: Build kernel
        run: |
          set -e
          cd kernel
          mkdir -p out

          make O=out ARCH=arm64 ${{ inputs.defconfig }}

          make -j$(nproc) \
            O=out ARCH=arm64 \
            CC=clang \
            LD=ld.lld \
            AR=llvm-ar \
            NM=llvm-nm \
            OBJCOPY=llvm-objcopy \
            OBJDUMP=llvm-objdump \
            STRIP=llvm-strip \
            2>&1 | tee build.log

      - name: Prepare AnyKernel3 ZIP
        if: success()
        run: |
          mkdir -p artifacts
          cd kernel

          git clone --depth=1 https://github.com/osm0sis/AnyKernel3
          cp out/arch/arm64/boot/Image AnyKernel3/Image

          cd AnyKernel3
          zip -r9 ../AnyKernel3-${{ inputs.device }}.zip .

          mv ../AnyKernel3-${{ inputs.device }}.zip ../artifacts/

      - name: Create GitHub Release
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "${{ inputs.device }}-${{ github.run_number }}"
          name: "Kernel | ${{ inputs.device }}"
          files: artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Telegram SUCCESS
        if: success()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT_ID}" \
            -d text="✅ Kernel build SUCCESS
Device: ${{ inputs.device }}
Branch: ${{ inputs.kernel_branch }}"

          curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendDocument" \
            -F chat_id="${TG_CHAT_ID}" \
            -F document=@artifacts/AnyKernel3-${{ inputs.device }}.zip

      - name: Telegram FAILURE
        if: failure()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT_ID}" \
            -d text="❌ Kernel build FAILED
Device: ${{ inputs.device }}"
