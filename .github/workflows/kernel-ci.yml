name: Android Kernel CI

on:
  workflow_dispatch:
    inputs:
      device:
        description: "Device codename"
        required: true
        default: "stone"

      defconfig:
        description: "Kernel defconfig"
        required: true
        default: "stone_defconfig"

      kernel_source:
        description: "Kernel source repo"
        required: true
        default: "https://github.com/termn0xh/CyberEdge_Kernel_Xiaomi_Stone.git"

      kernel_branch:
        description: "Kernel branch"
        required: true
        default: "main"

      kernelsu_next:
        description: "Enable KernelSU-Next"
        required: true
        type: boolean
        default: false

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      ARCH: arm64
      SUBARCH: arm64
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      TZ: Asia/Dhaka

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y git curl bc bison flex make ccache \
            libssl-dev libelf-dev dwarves gcc-aarch64-linux-gnu

      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-${{ inputs.device }}-${{ inputs.kernel_branch }}

      - name: Clone kernel source
        run: |
          git clone --depth=1 -b "${{ inputs.kernel_branch }}" \
          "${{ inputs.kernel_source }}" kernel

      - name: Setup Proton Clang
        run: |
          git clone --depth=1 https://github.com/kdrag0n/proton-clang.git clang
          echo "$PWD/clang/bin" >> $GITHUB_PATH

      - name: Enable KernelSU-Next
        if: ${{ inputs.kernelsu_next }}
        run: |
          cd kernel
          curl -LSs https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh | bash -

      - name: Build kernel
        run: |
          set -e
          cd kernel
          export CC=clang
          export LD=ld.lld
          export CROSS_COMPILE=aarch64-linux-gnu-
          mkdir -p out
          START=$(date +%s)
          make O=out "${{ inputs.defconfig }}"
          make -j$(nproc) O=out 2>&1 | tee build.log
          END=$(date +%s)
          echo "BUILD_TIME=$((END-START))" >> $GITHUB_ENV
          echo "SUCCESS=1" >> $GITHUB_ENV

      - name: Detect kernel info
        if: ${{ env.SUCCESS == '1' }}
        run: |
          cd kernel
          strings out/vmlinux | grep -m1 "Linux version" > kernel.info || true
          if grep -qi gki out/.config; then
            echo "KERNEL_TYPE=GKI" >> $GITHUB_ENV
          else
            echo "KERNEL_TYPE=NON-GKI" >> $GITHUB_ENV
          fi

      - name: Package AnyKernel3
        if: ${{ env.SUCCESS == '1' }}
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git ak3
          cp kernel/out/arch/arm64/boot/Image* ak3/ || true
          cd ak3
          zip -r9 ../AnyKernel-${{ inputs.device }}.zip *

      - name: Telegram Success Message
        if: ${{ env.SUCCESS == '1' }}
        run: |
          cd kernel
          KVER="$(cat kernel.info)"
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
            -d chat_id="$TG_CHAT_ID" \
            -d parse_mode=Markdown \
            --data-binary @- <<EOF
text=‚úÖ *Kernel Build Success*
üì± *Device:* \`${{ inputs.device }}\`
üß† *Type:* \`${KERNEL_TYPE}\`
üõ† *${KVER}*
‚è± *Build Time:* \`${BUILD_TIME}s\`
EOF

      - name: Telegram Upload ZIP
        if: ${{ env.SUCCESS == '1' }}
        run: |
          curl -s -F chat_id="$TG_CHAT_ID" \
          -F document=@AnyKernel-${{ inputs.device }}.zip \
          https://api.telegram.org/bot$TG_TOKEN/sendDocument

      - name: Telegram Failure
        if: failure()
        run: |
          DEVICE="${{ inputs.device }}"
          cd kernel || exit 0
          tail -n 300 build.log > error.log || true
          curl -s -F chat_id="$TG_CHAT_ID" \
            -F document=@error.log \
            -F caption="‚ùå Kernel build FAILED (${DEVICE})" \
            https://api.telegram.org/bot$TG_TOKEN/sendDocument
