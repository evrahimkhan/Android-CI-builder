name: Android Kernel CI

on:
  workflow_dispatch:
    inputs:
      device:
        description: Device codename
        required: true
        default: stone

      kernel_source:
        description: Kernel source URL
        required: true

      kernel_branch:
        description: Kernel branch
        required: true
        default: main

      defconfig:
        description: Kernel defconfig
        required: true
        default: stone_defconfig

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      TG_TOKEN: ${{ secrets.TG_TOKEN }}
      TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}

    steps:
      - name: Checkout CI repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            bc bison build-essential curl flex git \
            libssl-dev libelf-dev python3 zip unzip

      - name: Clone kernel source
        run: |
          git clone --depth=1 \
            -b "${{ inputs.kernel_branch }}" \
            "${{ inputs.kernel_source }}" kernel

      - name: Setup Clang
        run: |
          git clone --depth=1 https://github.com/llvm/llvm-project clang
          echo "$(pwd)/clang/bin" >> $GITHUB_PATH

      - name: Build kernel
        run: |
          set -e
          cd kernel
          mkdir -p out
          make O=out ARCH=arm64 "${{ inputs.defconfig }}"
          make -j$(nproc) \
            O=out ARCH=arm64 \
            CC=clang \
            LD=ld.lld \
            AR=llvm-ar \
            NM=llvm-nm \
            OBJCOPY=llvm-objcopy \
            OBJDUMP=llvm-objdump \
            STRIP=llvm-strip \
            2>&1 | tee build.log

      - name: Package AnyKernel3
        run: |
          mkdir -p artifacts
          cd kernel
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3
          cp out/arch/arm64/boot/Image AnyKernel3/Image
          cd AnyKernel3
          zip -r9 ../AnyKernel3-${{ inputs.device }}.zip .
          mv ../AnyKernel3-${{ inputs.device }}.zip ../artifacts/

      - name: Telegram SUCCESS
        if: success()
        run: |
          curl -X POST https://api.telegram.org/bot${TG_TOKEN}/sendMessage \
            -d chat_id=${TG_CHAT_ID} \
            -d text="✅ Kernel build SUCCESS for ${{ inputs.device }}"

          curl -X POST https://api.telegram.org/bot${TG_TOKEN}/sendDocument \
            -F chat_id=${TG_CHAT_ID} \
            -F document=@artifacts/AnyKernel3-${{ inputs.device }}.zip

      - name: Telegram FAILURE
        if: failure()
        run: |
          curl -X POST https://api.telegram.org/bot${TG_TOKEN}/sendMessage \
            -d chat_id=${TG_CHAT_ID} \
            -d text="❌ Kernel build FAILED for ${{ inputs.device }}"
