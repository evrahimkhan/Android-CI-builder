name: Android Kernel CI

on:
  workflow_dispatch:
    inputs:
      kernel_source:
        description: Kernel source git URL
        required: true
        type: string
      kernel_branch:
        description: Kernel branch
        required: true
        type: string
      device:
        description: Device codename
        required: true
        type: string
      defconfig:
        description: Kernel defconfig (e.g. vendor/moonstone_defconfig)
        required: true
        type: string
      kernelsu_next:
        description: Enable KernelSU-Next
        required: true
        default: "false"
        type: choice
        options: ["false", "true"]

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    env:
      ARCH: arm64
      SUBARCH: arm64

      TG_TOKEN: ${{ secrets.TG_TOKEN }}
      TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}

      CCACHE_DIR: ${{ github.workspace }}/.ccache

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive

      - name: Install dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            bc bison build-essential ccache curl flex git \
            libelf-dev libssl-dev make python3 rsync unzip wget zip zstd

      - name: Restore Proton Clang cache
        uses: actions/cache@v4
        with:
          path: clang
          key: proton-clang-v1

      - name: Setup Proton Clang
        run: |
          set -euo pipefail
          if [ ! -x clang/bin/clang ]; then
            git clone --depth=1 https://github.com/kdrag0n/proton-clang clang
          fi

      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-${{ runner.os }}-${{ inputs.kernel_branch }}-${{ inputs.defconfig }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ inputs.kernel_branch }}-${{ inputs.defconfig }}-
            ccache-${{ runner.os }}-

      - name: Clone Kernel Source
        run: |
          set -euo pipefail
          git clone --depth=1 -b "${{ inputs.kernel_branch }}" "${{ inputs.kernel_source }}" kernel

      - name: KernelSU-Next
        if: ${{ inputs.kernelsu_next == 'true' }}
        run: |
          set -euo pipefail
          cd kernel
          curl -LSs https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh | bash -

      - name: Telegram Build Start
        if: ${{ env.TG_TOKEN != '' && env.TG_CHAT_ID != '' }}
        run: |
          set -euo pipefail
          curl -sS -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT_ID}" \
            --data-urlencode text=$'Kernel Build Started\nDevice: ${{ inputs.device }}\nBranch: ${{ inputs.kernel_branch }}\nDefconfig: ${{ inputs.defconfig }}'

      - name: Build Kernel
        run: |
          set -euo pipefail

          export PATH="${GITHUB_WORKSPACE}/clang/bin:${PATH}"

          # ccache + clang
          ccache -M 5G || true
          ccache -z || true

          export CC="ccache clang"
          export CXX="ccache clang++"
          export LD=ld.lld
          export AR=llvm-ar
          export NM=llvm-nm
          export OBJCOPY=llvm-objcopy
          export OBJDUMP=llvm-objdump
          export STRIP=llvm-strip

          cd kernel
          mkdir -p out

          make O=out "${{ inputs.defconfig }}"

          START="$(date +%s)"
          if make -j"$(nproc)" O=out LLVM=1 LLVM_IAS=1 2>&1 | tee build.log; then
            echo "SUCCESS=1" >> "$GITHUB_ENV"
          else
            echo "SUCCESS=0" >> "$GITHUB_ENV"
            cp -f build.log error.log
          fi
          END="$(date +%s)"
          echo "BUILD_TIME=$((END-START))" >> "$GITHUB_ENV"

          KVER="$(make -s kernelversion | tr -d '\n')"
          CLANG_VER="$(clang --version | head -n1 | tr -d '\n')"
          printf "KERNEL_VERSION=%s\n" "$KVER" >> "$GITHUB_ENV"
          printf "CLANG_VERSION=%s\n" "$CLANG_VER" >> "$GITHUB_ENV"

          echo "ccache stats:"
          ccache -s || true

      - name: Detect GKI
        run: |
          set -euo pipefail
          if grep -q '^CONFIG_GKI=y' kernel/out/.config; then
            echo "KERNEL_TYPE=GKI" >> "$GITHUB_ENV"
          else
            echo "KERNEL_TYPE=NON-GKI" >> "$GITHUB_ENV"
          fi

      - name: Ensure AnyKernel core exists
        if: env.SUCCESS == '1'
        run: |
          set -euo pipefail

          test -f anykernel/anykernel.sh || { echo "Missing: anykernel/anykernel.sh"; exit 1; }

          if [ ! -f anykernel/tools/ak3-core.sh ]; then
            rm -rf anykernel_upstream
            git clone --depth=1 https://github.com/osm0sis/AnyKernel3 anykernel_upstream

            # Copy core structure in, but do NOT overwrite your custom anykernel.sh
            rsync -a --exclude 'anykernel.sh' anykernel_upstream/ anykernel/
            rm -rf anykernel_upstream
          fi

      - name: Package AnyKernel3
        if: env.SUCCESS == '1'
        run: |
          set -euo pipefail

          BOOTDIR="kernel/out/arch/arm64/boot"
          test -d "$BOOTDIR" || { echo "Missing boot dir: $BOOTDIR"; exit 1; }

          KIMG=""
          for f in Image.gz-dtb Image.gz Image.lz4 Image; do
            if [ -f "${BOOTDIR}/${f}" ]; then
              KIMG="$f"
              cp -f "${BOOTDIR}/${f}" "anykernel/${f}"
              break
            fi
          done

          if [ -z "$KIMG" ]; then
            echo "No kernel image found in ${BOOTDIR}"
            ls -la "$BOOTDIR" || true
            exit 1
          fi

          # Update your AnyKernel properties (works with your fixed properties() style)
          sed -i "s|^kernel.string=.*|kernel.string=${KERNEL_VERSION}|" anykernel/anykernel.sh
          sed -i "s|^device.name1=.*|device.name1=${{ inputs.device }}|" anykernel/anykernel.sh

          ZIP_NAME="Kernel-${{ inputs.device }}-${{ github.run_number }}.zip"
          (cd anykernel && zip -r9 "../${ZIP_NAME}" . -x "*.git*" )

          echo "ZIP_NAME=${ZIP_NAME}" >> "$GITHUB_ENV"
          echo "KERNEL_IMAGE_FILE=${KIMG}" >> "$GITHUB_ENV"

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ inputs.device }}-${{ github.run_number }}
          path: |
            Kernel-*.zip
            kernel/build.log
            kernel/error.log
          if-no-files-found: warn

      - name: GitHub Release
        if: env.SUCCESS == '1'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.run_number }}
          name: Kernel-${{ inputs.device }} (build ${{ github.run_number }})
          files: |
            ${{ env.ZIP_NAME }}
            kernel/build.log

      - name: Telegram Success
        if: ${{ env.SUCCESS == '1' && env.TG_TOKEN != '' && env.TG_CHAT_ID != '' }}
        run: |
          set -euo pipefail
          MSG=$'Kernel Build Success\nDevice: ${{ inputs.device }}\nType: '"$KERNEL_TYPE"$'\nLinux: '"$KERNEL_VERSION"$'\nToolchain: '"$CLANG_VERSION"$'\nTime: '"$BUILD_TIME"'s\nImage: '"$KERNEL_IMAGE_FILE"$'\nArtifact: '"$ZIP_NAME"
          curl -sS -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT_ID}" \
            --data-urlencode text="$MSG"

          curl -sS -F chat_id="$TG_CHAT_ID" \
            -F document=@"${ZIP_NAME}" \
            "https://api.telegram.org/bot${TG_TOKEN}/sendDocument"

          curl -sS -F chat_id="$TG_CHAT_ID" \
            -F document=@kernel/build.log \
            "https://api.telegram.org/bot${TG_TOKEN}/sendDocument"

      - name: Telegram Failure
        if: ${{ env.SUCCESS == '0' && env.TG_TOKEN != '' && env.TG_CHAT_ID != '' }}
        run: |
          set -euo pipefail
          test -f kernel/error.log || cp -f kernel/build.log kernel/error.log || true
          curl -sS -F chat_id="${TG_CHAT_ID}" \
            -F document=@kernel/error.log \
            -F caption="Kernel build FAILED | Device=${{ inputs.device }}" \
            "https://api.telegram.org/bot${TG_TOKEN}/sendDocument"
