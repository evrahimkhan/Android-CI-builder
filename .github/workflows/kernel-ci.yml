name: Android Kernel CI

on:
  workflow_dispatch:
    inputs:
      KERNEL_REPO:
        description: "Kernel repo URL"
        required: true
        default: "https://github.com/termn0xh/CyberEdge_Kernel_Xiaomi_Stone.git"
      KERNEL_BRANCH:
        description: "Kernel branch"
        required: true
        default: "main"
      DEVICE:
        description: "Device codename"
        required: true
        default: "stone"

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      TG_TOKEN: ${{ secrets.TG_TOKEN }}
      TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}

    steps:
      - name: Checkout (dummy)
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y git bc bison flex build-essential \
            curl zip unzip python3 clang lld

      - name: Clone kernel source
        run: |
          git clone --depth=1 -b "${{ github.event.inputs.KERNEL_BRANCH }}" \
            "${{ github.event.inputs.KERNEL_REPO }}" kernel
          echo "✅ Kernel cloned from correct branch"

      - name: Build kernel
        id: build
        run: |
          set +e
          START=$(date +%s)

          cd kernel || exit 1

          make defconfig
          make -j$(nproc) 2>&1 | tee build.log

          END=$(date +%s)
          echo "BUILD_TIME=$((END-START))" >> $GITHUB_ENV

          if [ -f arch/arm64/boot/Image ]; then
            echo "STATUS=SUCCESS" >> $GITHUB_ENV
          else
            echo "STATUS=FAILED" >> $GITHUB_ENV
            exit 1
          fi

      - name: Package outputs
        if: env.STATUS == 'SUCCESS'
        run: |
          cd kernel
          cp arch/arm64/boot/Image ../boot.img
          zip -r AnyKernel-${{ github.event.inputs.DEVICE }}.zip boot.img

      - name: Telegram SUCCESS
        if: env.STATUS == 'SUCCESS'
        run: |
          MSG="✅ Kernel SUCCESS
Device: ${{ github.event.inputs.DEVICE }}
Time: ${BUILD_TIME}s"

          curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT_ID}" \
            -d text="$MSG"

          curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendDocument" \
            -F chat_id="${TG_CHAT_ID}" \
            -F document=@AnyKernel-${{ github.event.inputs.DEVICE }}.zip

          curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendDocument" \
            -F chat_id="${TG_CHAT_ID}" \
            -F document=@boot.img

      - name: Telegram FAILED
        if: failure()
        run: |
          MSG="❌ Kernel FAILED
Device: ${{ github.event.inputs.DEVICE }}"

          curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT_ID}" \
            -d text="$MSG"

          [ -f kernel/build.log ] && \
          curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendDocument" \
            -F chat_id="${TG_CHAT_ID}" \
            -F document=@kernel/build.log
