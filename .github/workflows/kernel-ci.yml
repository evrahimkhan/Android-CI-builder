name: Universal Android Kernel CI

on:
  workflow_dispatch:
    inputs:
      CODENAME:
        description: "Device codename (e.g. moonstone)"
        required: true
        default: "moonstone"

      KERNEL_SOURCE:
        description: "Kernel source git link"
        required: true
        default: "https://github.com/vendor/kernel"

      KERNEL_BRANCH:
        description: "Kernel branch"
        required: true
        default: "android13"

      DEFCONFIG:
        description: "Defconfig (e.g. vendor_defconfig / gki_defconfig)"
        required: true
        default: "vendor_defconfig"

      TOOLCHAIN:
        description: "Select Clang Toolchain"
        required: true
        default: "proton"
        type: choice
        options: [proton, neutron]

      FORCE_GKI:
        description: "Force GKI build (auto-detect if false)"
        required: true
        default: "false"
        type: choice
        options: ["true", "false"]

      KERNELSU_NEXT:
        description: "Enable KernelSU-Next"
        required: true
        default: "false"
        type: choice
        options: ["true", "false"]

      SUSFS:
        description: "Enable SUSFS (KernelSU-Next only)"
        required: true
        default: "false"
        type: choice
        options: ["true", "false"]

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      ARCH: arm64
      SUBARCH: arm64
      TZ: Asia/Dhaka
      CCACHE_DIR: ~/.ccache
      CCACHE_MAXSIZE: 6G

    steps:
      - name: ğŸ“¥ Checkout CI repo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Clone kernel source
        run: |
          git clone --depth=1 -b ${{ inputs.KERNEL_BRANCH }} \
            ${{ inputs.KERNEL_SOURCE }} kernel

      - name: ğŸ§° Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            git curl bc bison flex \
            libssl-dev build-essential \
            python3 libncurses-dev \
            gcc-aarch64-linux-gnu \
            gcc-arm-linux-gnueabi \
            ccache zip mkbootimg

      - name: âš¡ Restore ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ inputs.CODENAME }}-${{ github.ref }}

      - name: âš™ï¸ Setup Clang
        run: |
          if [ "${{ inputs.TOOLCHAIN }}" = "proton" ]; then
            git clone --depth=1 https://github.com/kdrag0n/proton-clang clang
          else
            git clone --depth=1 https://github.com/Neutron-Toolchains/clang clang
          fi

          echo "PATH=$PWD/clang/bin:$PATH" >> $GITHUB_ENV
          echo "CC=ccache clang" >> $GITHUB_ENV
          echo "LD=ld.lld" >> $GITHUB_ENV
          echo "AR=llvm-ar" >> $GITHUB_ENV
          echo "NM=llvm-nm" >> $GITHUB_ENV
          echo "OBJCOPY=llvm-objcopy" >> $GITHUB_ENV
          echo "STRIP=llvm-strip" >> $GITHUB_ENV
          echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
          echo "CROSS_COMPILE_ARM32=arm-linux-gnueabi-" >> $GITHUB_ENV

      - name: ğŸ” Detect GKI / Non-GKI
        run: |
          cd kernel
          if [ "${{ inputs.FORCE_GKI }}" = "true" ]; then
            echo "KERNEL_TYPE=GKI" >> $GITHUB_ENV
          elif [ -d common ] || grep -qr "gki_defconfig" arch/arm64/configs; then
            echo "KERNEL_TYPE=GKI" >> $GITHUB_ENV
          else
            echo "KERNEL_TYPE=NON-GKI" >> $GITHUB_ENV
          fi

      - name: ğŸ” KernelSU-Next
        if: ${{ inputs.KERNELSU_NEXT == 'true' }}
        run: |
          cd kernel
          curl -LSs https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh | bash -
          if [ "${{ inputs.SUSFS }}" = "true" ]; then
            scripts/config --enable CONFIG_KSU_SUSFS
          fi

      - name: âš™ï¸ Configure kernel
        run: |
          cd kernel
          mkdir -p out
          make O=out ${{ inputs.DEFCONFIG }}

      - name: ğŸ›‘ vdso32 safe fix
        run: |
          cd kernel
          if grep -q CONFIG_COMPAT_VDSO=y out/.config; then
            echo "âš ï¸ Disabling vdso32"
            scripts/config --file out/.config \
              -d CONFIG_COMPAT_VDSO \
              -d CONFIG_ARM64_VDSO32
            make O=out olddefconfig
          fi

      - name: ğŸ—ï¸ Build kernel
        run: |
          cd kernel
          set -o pipefail
          make -j$(nproc) O=out \
            LLVM=1 LLVM_IAS=1 \
            KCFLAGS=-Wno-error \
            2>&1 | tee build.log

      - name: ğŸ“¦ AnyKernel3 (OTA-ready)
        run: |
          git clone https://github.com/osm0sis/AnyKernel3 anykernel
          cp kernel/out/arch/arm64/boot/Image anykernel/
          sed -i 's/do.devicecheck=1/do.devicecheck=0/' anykernel/anykernel.sh

      - name: ğŸ“¦ Create ZIP
        run: |
          cd anykernel
          zip -r9 ../AnyKernel-${{ inputs.CODENAME }}.zip *
          cd ..

      - name: ğŸ“± Build boot.img
        run: |
          mkbootimg \
            --kernel kernel/out/arch/arm64/boot/Image \
            --header_version 3 \
            -o boot.img

      - name: â¬†ï¸ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Kernel-${{ inputs.CODENAME }}
          path: |
            AnyKernel-*.zip
            boot.img
            kernel/build.log
