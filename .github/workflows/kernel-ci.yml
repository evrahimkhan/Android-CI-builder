name: Android Kernel CI

on:
  workflow_dispatch:
    inputs:
      codename:
        description: "Device codename (e.g. stone)"
        required: true
        type: string
      defconfig:
        description: "Defconfig name (e.g. stone_defconfig)"
        required: true
        type: string
      kernel_source:
        description: "Kernel source git URL"
        required: true
        type: string
      kernel_branch:
        description: "Kernel branch"
        required: true
        type: string
      enable_kernelsu:
        description: "Enable KernelSU-Next"
        required: true
        default: "false"
        type: choice
        options:
          - "true"
          - "false"

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            bc bison build-essential ccache flex git \
            libssl-dev python3 python3-pip zip unzip \
            gcc g++ clang lld

      - name: Setup ccache
        run: |
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
          ccache -M 20G

      - name: Clone kernel source
        run: |
          git clone --depth=1 \
            -b "${{ inputs.kernel_branch }}" \
            "${{ inputs.kernel_source }}" kernel

      - name: Clone Proton Clang
        run: |
          git clone --depth=1 https://github.com/kdrag0n/proton-clang clang

      - name: KernelSU-Next (optional)
        if: ${{ inputs.enable_kernelsu == 'true' }}
        run: |
          cd kernel
          curl -LSs https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh | bash -

      - name: Build kernel
        run: |
          set -o pipefail
          cd kernel

          export ARCH=arm64
          export SUBARCH=arm64
          export PATH="$GITHUB_WORKSPACE/clang/bin:/usr/lib/ccache:$PATH"

          export CC="ccache clang"
          export LD=ld.lld
          export LLVM=1
          export LLVM_IAS=1
          export HOSTCC=gcc
          export HOSTCXX=g++

          mkdir -p out

          make O=out ${{ inputs.defconfig }}

          # Disable WERROR (universal fix)
          scripts/config --file out/.config -d CONFIG_WERROR || true

          # Auto-disable vdso32 if present
          if grep -q CONFIG_COMPAT_VDSO=y out/.config; then
            echo "⚠️ COMPAT_VDSO detected, disabling"
            scripts/config --file out/.config \
              -d CONFIG_COMPAT_VDSO \
              -d CONFIG_VDSO32
          fi

          make O=out olddefconfig

          make -j$(nproc) O=out Image 2>&1 | tee build.log

      - name: Save build log
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: kernel/build.log

      - name: Save error log
        if: failure()
        run: |
          echo "Build failed" > error.log
        continue-on-error: true

      - name: Upload error log
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-log
          path: error.log

      - name: mkbootimg (AOSP)
        if: success()
        run: |
          git clone --depth=1 https://android.googlesource.com/platform/system/tools/mkbootimg tools/mkbootimg

          IMAGE=kernel/out/arch/arm64/boot/Image
          if [ ! -f "$IMAGE" ]; then
            echo "Image not found!"
            exit 1
          fi

          mkdir -p ramdisk
          (cd ramdisk && find . | cpio -o -H newc | gzip) > ramdisk.img

          HEADER_VER=4
          python3 tools/mkbootimg/mkbootimg.py \
            --kernel "$IMAGE" \
            --ramdisk ramdisk.img \
            --header_version $HEADER_VER \
            -o boot.img

      - name: AnyKernel3 ZIP
        if: success()
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3 ak3
          cp boot.img ak3/
          cd ak3
          zip -r9 ../AnyKernel3-${{ inputs.codename }}.zip *

      - name: Upload boot.img
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: boot-img
          path: boot.img

      - name: Upload AnyKernel ZIP
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: anykernel-zip
          path: AnyKernel3-${{ inputs.codename }}.zip
