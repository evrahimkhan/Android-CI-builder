name: Universal Android Kernel CI

on:
  workflow_dispatch:
    inputs:
      codename:
        description: "Device codename"
        required: true
        type: string
      defconfig:
        description: "Kernel defconfig"
        required: true
        type: string
      kernel_repo:
        description: "Kernel source repo URL"
        required: true
        type: string
      kernel_branch:
        description: "Kernel branch"
        required: true
        type: string
      telegram:
        description: "Enable Telegram notification"
        required: true
        type: boolean
        default: true

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      ARCH: arm64
      SUBARCH: arm64
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      CCACHE_COMPRESS: "1"
      CCACHE_MAXSIZE: 10G

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            git bc bison flex libssl-dev \
            make ccache curl jq \
            gcc g++ python3

      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-${{ github.ref }}
          restore-keys: ccache-

      - name: Clone kernel source
        run: |
          git clone --depth=1 \
            -b "${{ inputs.kernel_branch }}" \
            "${{ inputs.kernel_repo }}" kernel

      - name: Setup Proton Clang
        run: |
          git clone --depth=1 https://github.com/kdrag0n/proton-clang clang
          echo "$PWD/clang/bin" >> $GITHUB_PATH

      - name: Setup mkbootimg (AOSP)
        run: |
          git clone --depth=1 \
            https://android.googlesource.com/platform/system/tools/mkbootimg \
            tools/mkbootimg
          chmod +x tools/mkbootimg/mkbootimg.py

      - name: Setup AnyKernel3
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3 anykernel

      - name: Configure kernel
        run: |
          set -o pipefail
          cd kernel
          export PATH="/usr/lib/ccache:$PATH"
          export CC=clang
          export HOSTCC=gcc
          export HOSTCXX=g++
          export LD=ld.lld
          export LLVM=1
          export LLVM_IAS=1

          mkdir -p out
          make O=out "${{ inputs.defconfig }}"

          # vdso32 auto-disable
          if grep -q CONFIG_COMPAT_VDSO=y out/.config; then
            scripts/config --file out/.config \
              -d CONFIG_COMPAT_VDSO \
              -d CONFIG_VDSO32
            make O=out olddefconfig
          fi

      - name: Build kernel
        run: |
          cd kernel
          make -j$(nproc) O=out \
            CC="ccache clang" \
            HOSTCC=gcc \
            HOSTCXX=g++ \
            LD=ld.lld 2>&1 | tee build.log

      - name: Build boot.img
        run: |
          cd kernel
          IMG=out/arch/arm64/boot/Image
          HEADER=0

          if grep -q CONFIG_BOOT_HEADER_VERSION=3 out/.config; then
            HEADER=3
          elif grep -q CONFIG_BOOT_HEADER_VERSION=4 out/.config; then
            HEADER=4
          fi

          python3 ../tools/mkbootimg/mkbootimg.py \
            --kernel "$IMG" \
            --header_version "$HEADER" \
            --output boot.img

      - name: Prepare AnyKernel ZIP
        run: |
          cp kernel/out/arch/arm64/boot/Image anykernel/Image
          sed -i "s/device.name=.*/device.name=${{ inputs.codename }}/" anykernel/anykernel.sh
          cd anykernel
          zip -r9 ../AnyKernel3-${{ inputs.codename }}.zip *

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ inputs.codename }}
          path: |
            kernel/out/arch/arm64/boot/Image
            kernel/boot.img
            AnyKernel3-${{ inputs.codename }}.zip
            kernel/build.log

      - name: Telegram notify
        if: always() && inputs.telegram
        run: |
          STATUS="SUCCESS"
          LOG="build.log"
          if [ ! -f kernel/build.log ]; then
            STATUS="FAILED"
            LOG="error.log"
            echo "Build failed" > error.log
          fi

          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl -s -X POST https://api.telegram.org/bot${TG_TOKEN}/sendMessage \
            -d chat_id=${TG_CHAT_ID} \
            -d parse_mode=Markdown \
            -d text="*Kernel Build ${STATUS}*\n\n[View Run](${RUN_URL})" \
            -d reply_markup="{
              \"inline_keyboard\": [
                [{\"text\":\"⬇️ AnyKernel ZIP\",\"url\":\"${RUN_URL}\"}],
                [{\"text\":\"⬇️ boot.img\",\"url\":\"${RUN_URL}\"}],
                [{\"text\":\"⬇️ build.log\",\"url\":\"${RUN_URL}\"}],
                [{\"text\":\"⬇️ error.log\",\"url\":\"${RUN_URL}\"}]
              ]
            }"
