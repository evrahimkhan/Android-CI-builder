name: Android Kernel CI

on:
  workflow_dispatch:
    inputs:
      device:
        description: "Device codename"
        required: true
        default: "stone"

      kernel_repo:
        description: "Kernel source git URL"
        required: true

      kernel_branch:
        description: "Kernel git branch"
        required: true

      defconfig:
        description: "Kernel defconfig"
        required: true
        default: "stone_defconfig"

      kernelsu_next:
        description: "Enable KernelSU-Next"
        required: true
        default: "false"

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      ARCH: arm64
      SUBARCH: arm64
      CCACHE_DIR: ~/.ccache
      CCACHE_COMPRESS: 1

    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt update
          sudo apt install -y git curl bc bison flex \
            build-essential gcc g++ libssl-dev \
            libelf-dev python3 unzip ccache

      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ runner.os }}-${{ inputs.device }}
          restore-keys: ccache-${{ runner.os }}-

      - name: Clone kernel (selected branch)
        run: |
          git clone --depth=1 \
            -b "${{ inputs.kernel_branch }}" \
            "${{ inputs.kernel_repo }}" kernel

      - name: Setup Proton Clang
        run: |
          git clone --depth=1 https://github.com/kdrag0n/proton-clang clang
          echo "$(pwd)/clang/bin" >> $GITHUB_PATH

      - name: KernelSU-Next
        if: inputs.kernelsu_next == 'true'
        run: |
          cd kernel
          curl -LSs https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh | bash -

      - name: Release tag
        run: |
          echo "RELEASE_TAG=${{ inputs.device }}-$(date +%Y%m%d-%H%M)" >> $GITHUB_ENV

      - name: Build kernel
        run: |
          set -e
          cd kernel

          export HOSTCC=gcc
          export HOSTCXX=g++
          export HOSTLD=ld

          export CC=clang
          export LD=ld.lld
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CROSS_COMPILE_ARM32=arm-linux-gnueabi-

          mkdir -p out
          make O=out ${{ inputs.defconfig }}
          make -j$(nproc) O=out | tee build.log

      - name: Error log
        if: failure()
        run: |
          cd kernel
          tail -n 300 build.log > error.log

      - name: GitHub Release
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: "Kernel â€¢ ${{ inputs.device }}"
          files: |
            kernel/build.log
            kernel/out/arch/arm64/boot/Image*

      # âœ… FIXED TELEGRAM SUCCESS
      - name: Telegram SUCCESS
        if: success()
        run: |
          cat <<EOF > msg.txt
âœ… Kernel Build SUCCESS
ğŸ“± Device: ${{ inputs.device }}
ğŸŒ¿ Branch: ${{ inputs.kernel_branch }}
ğŸ” KernelSU-Next: ${{ inputs.kernelsu_next }}
ğŸ· Tag: ${{ env.RELEASE_TAG }}
EOF

          curl -s -F chat_id="${{ secrets.TG_CHAT_ID }}" \
               -F document=@kernel/build.log \
               -F caption="$(cat msg.txt)" \
               https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendDocument

      # âœ… FIXED TELEGRAM FAILURE
      - name: Telegram FAILURE
        if: failure()
        run: |
          cat <<EOF > msg.txt
âŒ Kernel Build FAILED
ğŸ“± Device: ${{ inputs.device }}
ğŸŒ¿ Branch: ${{ inputs.kernel_branch }}
EOF

          curl -s -F chat_id="${{ secrets.TG_CHAT_ID }}" \
               -F document=@kernel/error.log \
               -F caption="$(cat msg.txt)" \
               https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendDocument
