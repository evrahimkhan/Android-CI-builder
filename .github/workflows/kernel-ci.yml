name: Android Kernel CI

on:
  workflow_dispatch:
    inputs:
      codename:
        description: "Device codename (e.g. stone)"
        required: true
      defconfig:
        description: "Kernel defconfig (e.g. stone_defconfig)"
        required: true
      kernel_source:
        description: "Kernel source git URL"
        required: true
      kernel_branch:
        description: "Kernel git branch"
        required: true
      enable_kernelsu:
        description: "Enable KernelSU-Next"
        required: false
        default: "false"

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ARCH: arm64
      CC: clang
      LLVM: "1"
      LLVM_IAS: "1"

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          git curl zip unzip bc bison flex \
          build-essential python3 \
          libssl-dev libelf-dev ccache

    - name: Setup ccache
      run: |
        echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
        echo "CCACHE_MAXSIZE=10G" >> $GITHUB_ENV
        ccache -M 10G

    - name: Clone Proton Clang
      run: |
        git clone --depth=1 https://github.com/kdrag0n/proton-clang clang
        echo "$PWD/clang/bin" >> $GITHUB_PATH

    - name: Clone kernel source
      run: |
        git clone --depth=1 \
          -b "${{ inputs.kernel_branch }}" \
          "${{ inputs.kernel_source }}" kernel

    - name: KernelSU-Next
      if: ${{ inputs.enable_kernelsu == 'true' }}
      run: |
        cd kernel
        curl -LSs https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh | bash -

    - name: Start timer
      run: echo "BUILD_START=$(date +%s)" >> $GITHUB_ENV

    - name: Configure kernel
      run: |
        cd kernel
        mkdir -p out
        make O=out ${{ inputs.defconfig }}

    - name: Build kernel
      run: |
        cd kernel
        set -o pipefail
        make -j$(nproc) O=out 2>&1 | tee build.log

    - name: Collect info
      if: success()
      run: |
        cd kernel
        echo "KERNEL_VER=$(strings out/vmlinux | grep 'Linux version' | head -n1)" >> $GITHUB_ENV
        if grep -q CONFIG_GKI out/.config; then
          echo "KERNEL_TYPE=GKI" >> $GITHUB_ENV
        else
          echo "KERNEL_TYPE=NON-GKI" >> $GITHUB_ENV
        fi

    - name: Build stats
      if: success()
      run: |
        END=$(date +%s)
        echo "BUILD_TIME=$((END - BUILD_START))s" >> $GITHUB_ENV
        echo "IMAGE_SIZE=$(du -h kernel/out/arch/arm64/boot/Image | cut -f1)" >> $GITHUB_ENV

    - name: AnyKernel3
      if: success()
      run: |
        git clone --depth=1 https://github.com/osm0sis/AnyKernel3 anykernel
        cp kernel/out/arch/arm64/boot/Image anykernel/
        cd anykernel
        ZIP_NAME=${{ inputs.codename }}-kernel.zip
        zip -r9 "../$ZIP_NAME" *
        echo "AK_ZIP=$ZIP_NAME" >> $GITHUB_ENV

    - name: Build boot.img
      if: success()
      run: |
        git clone --depth=1 https://android.googlesource.com/platform/system/tools/mkbootimg tools/mkbootimg
        python3 tools/mkbootimg/mkbootimg.py \
          --kernel kernel/out/arch/arm64/boot/Image \
          --header_version 4 \
          -o boot.img

    - name: GitHub Release
      if: success()
      uses: softprops/action-gh-release@v2
      with:
        tag_name: "${{ inputs.codename }}-${{ github.run_number }}"
        name: "Kernel ‚Ä¢ ${{ inputs.codename }}"
        files: |
          ${{ env.AK_ZIP }}
          boot.img
          kernel/build.log

    - name: Telegram SUCCESS
      if: success()
      env:
        TG_TOKEN: ${{ secrets.TG_TOKEN }}
        TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        AK_ZIP: ${{ env.AK_ZIP }}
      run: |
        printf "‚úÖ Kernel Build SUCCESS\n\nüì± Device: %s\nüß† %s\nüî• %s\n‚è± %s\nüì¶ Image: %s\n" \
          "${{ inputs.codename }}" "$KERNEL_VER" "$KERNEL_TYPE" "$BUILD_TIME" "$IMAGE_SIZE" > msg.txt

        curl -s https://api.telegram.org/bot${TG_TOKEN}/sendMessage \
          -d chat_id="${TG_CHAT_ID}" \
          --data-urlencode text@"msg.txt"

        curl -s https://api.telegram.org/bot${TG_TOKEN}/sendDocument \
          -F chat_id="${TG_CHAT_ID}" \
          -F document=@"$AK_ZIP"

        curl -s https://api.telegram.org/bot${TG_TOKEN}/sendDocument \
          -F chat_id="${TG_CHAT_ID}" \
          -F document=@boot.img

    - name: Telegram FAILURE
      if: failure()
      env:
        TG_TOKEN: ${{ secrets.TG_TOKEN }}
        TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
      run: |
        curl -s https://api.telegram.org/bot${TG_TOKEN}/sendMessage \
          -d chat_id="${TG_CHAT_ID}" \
          -d text="‚ùå Kernel build FAILED for ${{ inputs.codename }}"
