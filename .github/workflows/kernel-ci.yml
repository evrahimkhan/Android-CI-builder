name: Universal Kernel CI

on:
  workflow_dispatch:
    inputs:
      codename:
        description: "Device codename"
        required: true
      defconfig:
        description: "Kernel defconfig"
        required: true
      kernel_repo:
        description: "Kernel source git URL"
        required: true
      kernel_branch:
        description: "Kernel branch"
        required: true

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout CI repo
      uses: actions/checkout@v4

    - name: Clone kernel source
      run: |
        git clone --depth=1 -b "${{ github.event.inputs.kernel_branch }}" \
          "${{ github.event.inputs.kernel_repo }}" kernel

    - name: Setup dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          bc bison build-essential ccache curl flex git \
          libssl-dev libelf-dev lld llvm \
          python3 unzip zip

    - name: Setup Proton Clang
      run: |
        git clone --depth=1 https://github.com/kdrag0n/proton-clang clang
        echo "$PWD/clang/bin" >> $GITHUB_PATH

    - name: Enable ccache
      run: |
        echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
        echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
        echo "CCACHE_MAXSIZE=10G" >> $GITHUB_ENV

    - name: Telegram notify (START)
      run: |
        curl -s -X POST https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TG_CHAT_ID }} \
          -d parse_mode=Markdown \
          -d text="üöÄ *Kernel CI Started*%0Aüì± Device: ${{ github.event.inputs.codename }}"

    - name: Build kernel
      id: build
      run: |
        set -o pipefail
        export ARCH=arm64
        export CC=clang
        export LLVM=1
        export LLVM_IAS=1

        cd kernel
        mkdir -p out
        make O=out "${{ github.event.inputs.defconfig }}"

        # vdso32 auto-fix
        if grep -q CONFIG_COMPAT_VDSO=y out/.config; then
          echo "Disabling vdso32"
          scripts/config --file out/.config \
            -d CONFIG_COMPAT_VDSO -d CONFIG_VDSO32
          make O=out olddefconfig
        fi

        make -j$(nproc) O=out 2>&1 | tee build.log

    - name: Detect GKI / Kernel info
      id: info
      run: |
        if grep -q "GKI" kernel/out/.config; then
          echo "type=GKI" >> $GITHUB_OUTPUT
        else
          echo "type=NON-GKI" >> $GITHUB_OUTPUT
        fi

        strings kernel/out/vmlinux | grep "Linux version" | head -n1 > kernel_version.txt
        clang --version | head -n1 > clang_version.txt

    - name: Build boot.img (auto v3/v4)
      run: |
        git clone --depth=1 https://android.googlesource.com/platform/system/tools/mkbootimg tools/mkbootimg
        IMG=kernel/out/arch/arm64/boot/Image

        if grep -q "header_version 4" kernel/out/.config; then
          HV=4
        else
          HV=3
        fi

        python3 tools/mkbootimg/mkbootimg.py \
          --kernel "$IMG" \
          --header_version $HV \
          -o boot.img

    - name: Build AnyKernel3 ZIP
      run: |
        cp kernel/out/arch/arm64/boot/Image AnyKernel3/
        cd AnyKernel3
        zip -r9 ../AnyKernel3-${{ github.event.inputs.codename }}.zip *

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kernel-build
        path: |
          kernel/build.log
          boot.img
          AnyKernel3-${{ github.event.inputs.codename }}.zip

    - name: GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: "${{ github.run_number }}"
        files: |
          boot.img
          AnyKernel3-${{ github.event.inputs.codename }}.zip

    - name: Telegram notify (SUCCESS)
      if: success()
      run: |
        KVER=$(cat kernel_version.txt)
        CLANG=$(cat clang_version.txt)

        curl -s -X POST https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TG_CHAT_ID }} \
          -d parse_mode=Markdown \
          -d text="‚úÖ *Build Success*%0A\
üì± ${{ github.event.inputs.codename }}%0A\
üß† ${{ steps.info.outputs.type }}%0A\
üêß ${KVER}%0A\
üõ† ${CLANG}"

        for f in boot.img AnyKernel3-${{ github.event.inputs.codename }}.zip kernel/build.log; do
          curl -F document=@$f \
            https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendDocument \
            -F chat_id=${{ secrets.TG_CHAT_ID }}
        done

    - name: Telegram notify (FAILED)
      if: failure()
      run: |
        curl -s -X POST https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TG_CHAT_ID }} \
          -d parse_mode=Markdown \
          -d text="‚ùå *Kernel Build Failed*%0A\
üì± ${{ github.event.inputs.codename }}%0A\
üîó https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
