name: Universal Android Kernel CI

on:
  workflow_dispatch:
    inputs:
      codename:
        description: "Device codename (e.g. moonstone)"
        required: true
        type: string
      defconfig:
        description: "Kernel defconfig (e.g. stone_defconfig)"
        required: true
        type: string
      kernel_repo:
        description: "Kernel source git URL"
        required: true
        type: string
      kernel_branch:
        description: "Kernel branch"
        required: true
        type: string
      enable_kernelsu:
        description: "Enable KernelSU-Next (true/false)"
        required: true
        default: "false"
        type: string

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      ARCH: arm64
      SUBARCH: arm64
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      CCACHE_COMPRESS: "1"
      CCACHE_MAXSIZE: 10G

    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            git bc bison flex libssl-dev \
            make ccache curl jq \
            gcc g++ \
            python3 python3-pip

      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-${{ github.ref }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ github.ref }}
            ccache-

      - name: Clone kernel source
        run: |
          git clone --depth=1 \
            -b "${{ inputs.kernel_branch }}" \
            "${{ inputs.kernel_repo }}" kernel

      - name: Setup Proton Clang
        run: |
          git clone --depth=1 https://github.com/kdrag0n/proton-clang clang
          echo "${PWD}/clang/bin" >> $GITHUB_PATH

      - name: Setup mkbootimg (v3/v4 compatible)
        run: |
          git clone --depth=1 https://github.com/osm0sis/mkbootimg tools/mkbootimg
          chmod +x tools/mkbootimg/mkbootimg.py

      - name: KernelSU-Next integration
        if: ${{ inputs.enable_kernelsu == 'true' }}
        run: |
          cd kernel
          curl -LSs https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh | bash -

      - name: Configure kernel
        run: |
          set -o pipefail
          cd kernel

          export PATH="/usr/lib/ccache:$PATH"
          export CC=clang
          export HOSTCC=gcc
          export HOSTCXX=g++
          export LD=ld.lld
          export LLVM=1
          export LLVM_IAS=1

          mkdir -p out
          make O=out "${{ inputs.defconfig }}"

          # vdso32 auto-disable (arm32 linker fix)
          if grep -q CONFIG_COMPAT_VDSO=y out/.config; then
            echo "⚠️ COMPAT_VDSO detected, disabling vdso32"
            scripts/config --file out/.config \
              -d CONFIG_COMPAT_VDSO \
              -d CONFIG_VDSO32
            make O=out olddefconfig
          fi

      - name: Build kernel
        run: |
          set -o pipefail
          cd kernel

          make -j$(nproc) O=out \
            CC="ccache clang" \
            HOSTCC=gcc \
            HOSTCXX=g++ \
            LD=ld.lld

      - name: Detect GKI / Non-GKI
        id: gki
        run: |
          cd kernel
          if grep -q "GKI" out/include/generated/utsrelease.h; then
            echo "type=GKI" >> $GITHUB_OUTPUT
          else
            echo "type=Non-GKI" >> $GITHUB_OUTPUT
          fi

      - name: Build boot.img (auto header detect)
        run: |
          cd kernel
          KERNEL_IMG="out/arch/arm64/boot/Image"

          if [ ! -f "$KERNEL_IMG" ]; then
            echo "Kernel Image not found"
            exit 1
          fi

          HEADER_VER=0
          if grep -q "HEADER_VERSION 3" out/.config; then
            HEADER_VER=3
          fi

          python3 ../tools/mkbootimg/mkbootimg.py \
            --kernel "$KERNEL_IMG" \
            --header_version "$HEADER_VER" \
            --output boot.img

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ inputs.codename }}
          path: |
            kernel/out/arch/arm64/boot/Image
            kernel/boot.img

      - name: Telegram notify
        if: always()
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          ART_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          curl -s -X POST "https://api.telegram.org/bot$TG_TOKEN/sendMessage" \
            -d chat_id="$TG_CHAT_ID" \
            -d text="✅ Kernel build finished (${{
              steps.gki.outputs.type }})" \
            -d reply_markup="$(jq -nc --arg url "$ART_URL" \
              '{inline_keyboard:[[{"text":"⬇️ Download Artifacts","url":$url}]]}')"
