name: Android Kernel CI

on:
  workflow_dispatch:
    inputs:
      device:
        description: "Device codename (e.g. stone)"
        required: true
      defconfig:
        description: "Kernel defconfig (e.g. stone_defconfig)"
        required: true
      kernel_source:
        description: "Kernel source git URL"
        required: true
      kernel_branch:
        description: "Kernel branch"
        required: true
      enable_kernelsu_next:
        description: "Enable KernelSU-Next (true/false)"
        required: false
        default: "false"

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      TZ: Asia/Dhaka
      CCACHE_DIR: ${{ github.workspace }}/.ccache

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential bc bison flex \
          libssl-dev libelf-dev libncurses-dev \
          libc6-dev binutils python3 git \
          ccache curl zip unzip

    - name: Setup ccache
      run: |
        echo "CCACHE_MAXSIZE=10G" >> $GITHUB_ENV
        ccache -M 10G

    - name: Clone kernel source (input branch)
      run: |
        git clone --depth=1 \
          -b "${{ inputs.kernel_branch }}" \
          "${{ inputs.kernel_source }}" kernel

    - name: Clone Proton Clang
      run: |
        git clone --depth=1 https://github.com/kdrag0n/proton-clang.git clang
        echo "$PWD/clang/bin" >> $GITHUB_PATH

    - name: Setup HOST & TARGET toolchains
      run: |
        echo "ARCH=arm64" >> $GITHUB_ENV
        echo "SUBARCH=arm64" >> $GITHUB_ENV

        echo "HOSTCC=gcc" >> $GITHUB_ENV
        echo "HOSTCXX=g++" >> $GITHUB_ENV
        echo "HOSTLD=ld" >> $GITHUB_ENV

        echo "CC=clang" >> $GITHUB_ENV
        echo "LD=ld.lld" >> $GITHUB_ENV
        echo "LLVM=1" >> $GITHUB_ENV
        echo "LLVM_IAS=1" >> $GITHUB_ENV

    - name: Enable KernelSU-Next
      if: ${{ inputs.enable_kernelsu_next == 'true' }}
      run: |
        cd kernel
        curl -LSs https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh | bash -

    - name: Build kernel
      run: |
        set -o pipefail
        cd kernel
        make O=out ${{ inputs.defconfig }}
        make -j$(nproc) O=out 2>&1 | tee build.log

    - name: Extract kernel info
      if: success()
      run: |
        cd kernel
        echo "KERNEL_VERSION=$(strings out/vmlinux | grep -m1 'Linux version')" >> $GITHUB_ENV
        echo "CLANG_VERSION=$(clang --version | head -n1)" >> $GITHUB_ENV

    - name: Build AnyKernel3 ZIP
      if: success()
      run: |
        git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git anykernel
        cp kernel/out/arch/arm64/boot/Image anykernel/Image

        sed -i "s/kernel.string=.*/kernel.string=${{ env.KERNEL_VERSION }}/" anykernel/anykernel.sh || true

        cd anykernel
        zip -r9 ../AnyKernel3-${{ inputs.device }}.zip .

    - name: Upload GitHub artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: kernel-artifacts
        path: |
          kernel/build.log
          kernel/out/arch/arm64/boot/Image
          AnyKernel3-${{ inputs.device }}.zip

    - name: Create GitHub Release
      if: success()
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ inputs.device }}-${{ github.run_number }}
        name: Kernel ${{ inputs.device }} build #${{ github.run_number }}
        files: |
          AnyKernel3-${{ inputs.device }}.zip
          kernel/out/arch/arm64/boot/Image

    # ---------------- TELEGRAM ----------------

    - name: Telegram SUCCESS message
      if: success()
      run: |
        curl -s -X POST https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TG_CHAT_ID }} \
          -d text="âœ… Kernel build SUCCESS

Device: ${{ inputs.device }}
Kernel: ${{ env.KERNEL_VERSION }}
Compiler: ${{ env.CLANG_VERSION }}"

    - name: Telegram upload AnyKernel ZIP
      if: success()
      run: |
        curl -s -X POST https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendDocument \
          -F chat_id=${{ secrets.TG_CHAT_ID }} \
          -F document=@AnyKernel3-${{ inputs.device }}.zip

    - name: Telegram upload Image
      if: success()
      run: |
        curl -s -X POST https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendDocument \
          -F chat_id=${{ secrets.TG_CHAT_ID }} \
          -F document=@kernel/out/arch/arm64/boot/Image

    - name: Telegram upload build.log
      if: success()
      run: |
        curl -s -X POST https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendDocument \
          -F chat_id=${{ secrets.TG_CHAT_ID }} \
          -F document=@kernel/build.log

    - name: Telegram FAILURE upload log
      if: failure()
      run: |
        curl -s -X POST https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendDocument \
          -F chat_id=${{ secrets.TG_CHAT_ID }} \
          -F document=@kernel/build.log
