name: Universal Android Kernel CI

on:
  workflow_dispatch:
    inputs:
      codename:
        description: "Device codename"
        required: true
        default: "stone"
      defconfig:
        description: "Kernel defconfig"
        required: true
        default: "stone_defconfig"
      kernel_repo:
        description: "Kernel source repo"
        required: true
        default: "https://github.com/USERNAME/KERNEL"
      kernel_branch:
        description: "Kernel branch"
        required: true
        default: "main"

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout (dummy)
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            bc bison flex build-essential \
            libssl-dev libelf-dev \
            clang lld llvm \
            ccache git curl python3

      - name: Setup ccache
        run: |
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          echo "CCACHE_MAXSIZE=10G" >> $GITHUB_ENV

      - name: Clone kernel source
        run: |
          git clone --depth=1 \
            -b "${{ github.event.inputs.kernel_branch }}" \
            "${{ github.event.inputs.kernel_repo }}" kernel

      - name: Clone Proton Clang
        run: |
          git clone --depth=1 https://github.com/kdrag0n/proton-clang clang

      - name: Build kernel
        run: |
          set -e
          export PATH="$PWD/clang/bin:$PATH"
          export ARCH=arm64
          export CC=clang
          export LLVM=1
          export LLVM_IAS=1
          export USE_CCACHE=1

          cd kernel
          mkdir -p out
          make O=out ${{ github.event.inputs.defconfig }}

          # Disable vdso32 if enabled (arm64 CI fix)
          if grep -q CONFIG_COMPAT_VDSO=y out/.config; then
            scripts/config --file out/.config \
              -d CONFIG_COMPAT_VDSO \
              -d CONFIG_VDSO32
            make O=out olddefconfig
          fi

          make -j$(nproc) O=out

      - name: Detect kernel type (GKI / NON-GKI)
        id: gki
        run: |
          if [ -f kernel/out/arch/arm64/boot/Image.gz ]; then
            echo "type=GKI" >> $GITHUB_OUTPUT
          else
            echo "type=NON-GKI" >> $GITHUB_OUTPUT
          fi

      - name: Collect artifacts
        run: |
          mkdir -p artifacts
          cp kernel/out/arch/arm64/boot/Image artifacts/Image

      - name: Upload Image
        uses: actions/upload-artifact@v4
        with:
          name: Kernel-Image
          path: artifacts/Image
