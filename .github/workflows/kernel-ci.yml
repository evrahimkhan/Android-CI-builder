name: Android Kernel CI

on:
  workflow_dispatch:
    inputs:
      device:
        description: "Device codename"
        required: true
        default: stone
      kernel_source:
        description: "Kernel source git URL"
        required: true
      kernel_branch:
        description: "Kernel branch"
        required: true
        default: main
      defconfig:
        description: "Kernel defconfig"
        required: true
        default: stone_defconfig
      kernelsu_next:
        description: "Enable KernelSU-Next"
        type: boolean
        default: false

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      ARCH: arm64
      SUBARCH: arm64
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      CCACHE_COMPRESS: 1

    steps:
      - name: Checkout CI repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            bc bison flex libssl-dev \
            build-essential ccache \
            git curl zip unzip python3

      - name: Setup ccache
        run: |
          echo "CCACHE_DIR=${CCACHE_DIR}" >> $GITHUB_ENV
          echo "/usr/lib/ccache" >> $GITHUB_PATH

      - name: Clone Proton Clang
        run: |
          git clone --depth=1 https://github.com/kdrag0n/proton-clang clang
          echo "${PWD}/clang/bin" >> $GITHUB_PATH

      - name: Clone Kernel Source (selected branch)
        run: |
          git clone --depth=1 \
            -b "${{ inputs.kernel_branch }}" \
            "${{ inputs.kernel_source }}" kernel

      - name: Apply KernelSU-Next
        if: ${{ inputs.kernelsu_next }}
        run: |
          cd kernel
          curl -LSs https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh | bash -

      - name: Build Kernel
        run: |
          set -o pipefail
          cd kernel
          mkdir -p out
          export CC=clang
          export LD=ld.lld
          export CROSS_COMPILE=aarch64-linux-gnu-
          make O=out "${{ inputs.defconfig }}"
          make -j$(nproc) O=out 2>&1 | tee build.log

      - name: Extract Kernel Info
        if: success()
        run: |
          cd kernel
          strings out/vmlinux | grep "Linux version" | head -n1 > kernel.info || true

      - name: Package AnyKernel3
        if: success()
        run: |
          cd kernel
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3 ak3
          cp out/arch/arm64/boot/Image ak3/
          cd ak3
          zip -r9 ../AnyKernel3-${{ inputs.device }}.zip .

      - name: GitHub Release
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: kernel-${{ github.run_number }}
          name: Kernel ${{ inputs.device }}
          files: |
            kernel/AnyKernel3-${{ inputs.device }}.zip
            kernel/build.log
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Telegram Success
        if: success()
        run: |
          cd kernel
          KVER=$(cat kernel.info 2>/dev/null || echo unknown)
          TEXT="‚úÖ Kernel Build Success\nüì± Device: ${{ inputs.device }}\nüåø Branch: ${{ inputs.kernel_branch }}\nüß† ${KVER}"
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TG_CHAT_ID }}" \
            --data-urlencode "text=${TEXT}"

          curl -s -F chat_id="${{ secrets.TG_CHAT_ID }}" \
            -F document=@AnyKernel3-${{ inputs.device }}.zip \
            https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendDocument

          curl -s -F chat_id="${{ secrets.TG_CHAT_ID }}" \
            -F document=@build.log \
            https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendDocument

      - name: Telegram Failure
        if: failure()
        run: |
          cd kernel || exit 0
          tail -n 300 build.log > error.log || true
          curl -s -F chat_id="${{ secrets.TG_CHAT_ID }}" \
            -F document=@error.log \
            -F caption="‚ùå Kernel build FAILED (${{ inputs.device }})" \
            https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendDocument
