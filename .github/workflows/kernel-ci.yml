name: Android Kernel CI

on:
  workflow_dispatch:
    inputs:
      kernel_source:
        description: Kernel source git URL
        required: true
        type: string
      kernel_branch:
        description: Kernel branch
        required: true
        type: string
      device:
        description: Device codename (for naming only)
        required: true
        type: string
      defconfig:
        description: Kernel defconfig (e.g. vendor/moonstone_defconfig)
        required: true
        type: string

      # Base image parameters removed as image repacking process has been removed
      # Only AnyKernel ZIP creation is now used for flashing

      enable_custom_config:
        description: Enable custom Kconfig branding
        required: true
        default: "false"
        type: choice
        options: ["false", "true"]
      config_localversion:
        description: CONFIG_LOCALVERSION
        required: false
        default: "-CI"
        type: string
      config_default_hostname:
        description: CONFIG_DEFAULT_HOSTNAME
        required: false
        default: "CI Builder"
        type: string
      config_uname_override_string:
        description: CONFIG_UNAME_OVERRIDE_STRING
        required: false
        default: ""
        type: string
      config_cc_version_text:
        description: Optional override for CONFIG_CC_VERSION_TEXT (blank = auto)
        required: false
        default: ""
        type: string

      enable_nethunter_config:
        description: Enable NetHunter kernel configurations
        required: true
        default: "false"
        type: choice
        options: ["false", "true"]

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    env:
      ARCH: arm64
      SUBARCH: arm64
      TG_TOKEN: ${{ secrets.TG_TOKEN }}
      TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
      CCACHE_DIR: ${{ github.workspace }}/.ccache

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive

      - name: Make CI scripts executable
        shell: bash
        run: |
          set -euo pipefail
          chmod +x ci/*.sh

      - name: Install dependencies
        shell: bash
        run: ci/run_logged.sh ci/install_deps.sh

      - name: Restore Proton Clang cache
        uses: actions/cache@v4
        with:
          path: clang
          key: proton-clang-v1

      - name: Setup Proton Clang
        shell: bash
        run: ci/run_logged.sh ci/setup_proton_clang.sh

      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-${{ runner.os }}-${{ inputs.kernel_branch }}-${{ inputs.defconfig }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ inputs.kernel_branch }}-${{ inputs.defconfig }}-
            ccache-${{ runner.os }}-

      - name: Clone Kernel Source
        shell: bash
        run: ci/run_logged.sh ci/clone_kernel.sh "${{ inputs.kernel_source }}" "${{ inputs.kernel_branch }}"

      - name: Patch unsupported Polly flags
        shell: bash
        run: ci/run_logged.sh ci/patch_polly.sh

      - name: Telegram Build Start
        if: ${{ env.TG_TOKEN != '' && env.TG_CHAT_ID != '' }}
        shell: bash
        run: ci/telegram.sh start "${{ inputs.device }}" "${{ inputs.kernel_branch }}" "${{ inputs.defconfig }}" "" "" "" "${{ inputs.enable_custom_config }}" "${{ inputs.config_localversion }}" "${{ inputs.config_default_hostname }}" "${{ inputs.config_uname_override_string }}" "${{ inputs.config_cc_version_text }}" "${{ inputs.enable_nethunter_config }}"

      - name: Build Kernel
        shell: bash
        env:
          CUSTOM_CONFIG_ENABLED: ${{ inputs.enable_custom_config }}
          CFG_LOCALVERSION: ${{ inputs.config_localversion }}
          CFG_DEFAULT_HOSTNAME: ${{ inputs.config_default_hostname }}
          CFG_UNAME_OVERRIDE_STRING: ${{ inputs.config_uname_override_string }}
          CFG_CC_VERSION_TEXT: ${{ inputs.config_cc_version_text }}
        run: ci/run_logged.sh ci/build_kernel.sh "${{ inputs.defconfig }}"

      - name: Detect GKI
        shell: bash
        run: ci/run_logged.sh ci/detect_gki.sh

      - name: Apply NetHunter configurations
        if: inputs.enable_nethunter_config == 'true'
        shell: bash
        run: ci/run_logged.sh ci/enable_nethunter_config.sh

      - name: Ensure AnyKernel core exists
        if: env.SUCCESS == '1'
        shell: bash
        run: ci/run_logged.sh ci/ensure_anykernel_core.sh

      - name: Package AnyKernel ZIP
        if: env.SUCCESS == '1'
        shell: bash
        env:
          CUSTOM_CONFIG_ENABLED: ${{ inputs.enable_custom_config }}
          CFG_LOCALVERSION: ${{ inputs.config_localversion }}
          CFG_DEFAULT_HOSTNAME: ${{ inputs.config_default_hostname }}
          CFG_UNAME_OVERRIDE_STRING: ${{ inputs.config_uname_override_string }}
          CFG_CC_VERSION_TEXT: ${{ inputs.config_cc_version_text }}
        run: ci/run_logged.sh ci/package_anykernel.sh "${{ inputs.device }}"

      # Removed image repacking process as requested
      # Only AnyKernel ZIP will be created for flashing

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ inputs.device }}-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            Kernel-*.zip
            kernel/build.log
            kernel/error.log
          if-no-files-found: warn

      - name: GitHub Release
        if: env.SUCCESS == '1'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.run_id }}-${{ github.run_attempt }}
          name: Kernel-${{ inputs.device }} (run ${{ github.run_id }}/${{ github.run_attempt }})
          fail_on_unmatched_files: false
          files: |
            Kernel-*.zip
            kernel/build.log

      - name: Telegram Success
        if: ${{ env.SUCCESS == '1' && env.TG_TOKEN != '' && env.TG_CHAT_ID != '' }}
        shell: bash
        run: ci/telegram.sh success "${{ inputs.device }}"

      - name: Telegram Failure
        if: ${{ env.SUCCESS == '0' && env.TG_TOKEN != '' && env.TG_CHAT_ID != '' }}
        shell: bash
        run: ci/telegram.sh failure "${{ inputs.device }}"

      - name: Mark workflow failed if kernel build failed
        if: env.SUCCESS == '0'
        shell: bash
        run: exit 1
