name: Universal Android Kernel CI (Proton Clang)

on:
  workflow_dispatch:
    inputs:
      codename:
        description: "Device codename (e.g. moonstone)"
        required: true
      defconfig:
        description: "Kernel defconfig (e.g. vendor/moonstone_defconfig)"
        required: true
      kernel_source:
        description: "Kernel source git URL"
        required: true
      kernel_branch:
        description: "Kernel branch"
        required: true
        default: "main"
      enable_ksu_next:
        description: "Enable KernelSU-Next"
        required: true
        default: "false"
        type: choice
        options: [true, false]
      enable_susfs:
        description: "Enable SUSFS (KernelSU)"
        required: true
        default: "false"
        type: choice
        options: [true, false]
      telegram_notify:
        description: "Telegram notification"
        required: true
        default: "true"
        type: choice
        options: [true, false]

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ARCH: arm64
      SUBARCH: arm64
      OUT: out
      CCACHE_DIR: ~/.ccache

    steps:
      - name: Checkout CI repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            git curl bc bison flex libssl-dev make \
            python3 unzip zip ccache \
            gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi

      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ github.run_id }}
          restore-keys: ccache-

      - name: Clone kernel source
        run: |
          git clone --depth=1 \
            -b "${{ inputs.kernel_branch }}" \
            "${{ inputs.kernel_source }}" kernel

      - name: Setup Proton Clang (default)
        run: |
          git clone --depth=1 https://github.com/kdrag0n/proton-clang.git clang
          echo "PATH=$PWD/clang/bin:$PATH" >> $GITHUB_ENV
          clang --version

      - name: Setup mkbootimg
        run: |
          git clone https://github.com/osm0sis/mkbootimg tools/mkbootimg
          chmod +x tools/mkbootimg/mkbootimg.py

      - name: KernelSU-Next (optional)
        if: ${{ inputs.enable_ksu_next == 'true' }}
        run: |
          cd kernel
          curl -LSs https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh | bash -
          if [ "${{ inputs.enable_susfs }}" = "true" ]; then
            scripts/config --enable CONFIG_KSU_SUSFS
          fi

      - name: Configure kernel
        run: |
          cd kernel
          mkdir -p $OUT
          make O=$OUT "${{ inputs.defconfig }}"

          # vdso32 auto-fix (universal safe)
          if grep -q CONFIG_COMPAT_VDSO=y $OUT/.config; then
            echo "⚠️ COMPAT_VDSO detected, disabling vdso32"
            scripts/config --file $OUT/.config -d CONFIG_COMPAT_VDSO
            make O=$OUT olddefconfig
          fi

      - name: Build kernel
        run: |
          cd kernel
          set -o pipefail
          make -j$(nproc) O=$OUT \
            CC="ccache clang" \
            LD=ld.lld AR=llvm-ar NM=llvm-nm \
            STRIP=llvm-strip OBJCOPY=llvm-objcopy \
            OBJDUMP=llvm-objdump \
            CROSS_COMPILE=aarch64-linux-gnu- \
            CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
            KCFLAGS="-Wno-error" \
            2>&1 | tee build.log || (mv build.log error.log && exit 1)

      - name: Build boot.img (header v3 safe)
        run: |
          cd kernel
          python3 ../tools/mkbootimg/mkbootimg.py \
            --kernel $OUT/arch/arm64/boot/Image \
            --header_version 3 \
            --output boot.img

      - name: AnyKernel3 (OTA ready)
        run: |
          git clone https://github.com/osm0sis/AnyKernel3.git anykernel
          cp kernel/boot.img anykernel/
          cd anykernel
          zip -r Kernel-${{ inputs.codename }}.zip .

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Kernel-${{ inputs.codename }}
          path: |
            kernel/build.log
            kernel/error.log
            kernel/boot.img
            anykernel/Kernel-*.zip

      - name: Telegram notification
        if: ${{ inputs.telegram_notify == 'true' }}
        run: |
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendMessage" \
            -d chat_id=${{ secrets.TG_CHAT_ID }} \
            -d text="✅ Kernel build finished for *${{ inputs.codename }}*" \
            -d parse_mode=Markdown \
            -d reply_markup='{
              "inline_keyboard":[
                [{"text":"⬇️ Download Artifacts","url":"'"$RUN_URL"'"}]
              ]
            }'
