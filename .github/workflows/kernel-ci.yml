name: Android Kernel CI

on:
  workflow_dispatch:
    inputs:
      DEVICE:
        description: "Device codename (e.g. moonstone)"
        required: true
        default: "moonstone"
      KERNEL_TYPE:
        description: "Kernel type (GKI / NON-GKI)"
        required: true
        default: "GKI"

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      ARCH: arm64
      SUBARCH: arm64
      DEVICE: ${{ github.event.inputs.DEVICE }}
      KERNEL_TYPE: ${{ github.event.inputs.KERNEL_TYPE }}
      TG_TOKEN: ${{ secrets.TG_TOKEN }}
      TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      CCACHE_COMPRESS: 1
      CCACHE_MAXSIZE: 5G

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            bc bison build-essential ccache curl flex git \
            libssl-dev libelf-dev lld llvm lz4 unzip zip

      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-${{ runner.os }}-${{ env.DEVICE }}

      # âœ… FIXED â€” YAML safe multiline message
      - name: Telegram build started
        run: |
          MSG=$(cat <<EOF
ðŸš€ Kernel Build Started
ðŸ“± Device: ${DEVICE}
ðŸŒ¿ Branch: ${GITHUB_REF_NAME}
EOF
          )

          curl -s -X POST https://api.telegram.org/bot${TG_TOKEN}/sendMessage \
            -d chat_id="${TG_CHAT_ID}" \
            --data-urlencode "text=${MSG}"

      - name: Setup Proton Clang
        run: |
          git clone --depth=1 https://github.com/kdrag0n/proton-clang clang
          echo "PATH=$PWD/clang/bin:$PATH" >> $GITHUB_ENV

      - name: Build Kernel
        run: |
          set +e
          START=$(date +%s)

          make O=out ARCH=arm64 ${DEVICE}_defconfig
          make -j$(nproc) O=out ARCH=arm64 2>&1 | tee build.log

          END=$(date +%s)
          echo "BUILD_TIME=$((END-START))" >> $GITHUB_ENV

          if [ ! -f out/arch/arm64/boot/Image ] && \
             [ ! -f out/arch/arm64/boot/Image.gz ] && \
             [ ! -f out/arch/arm64/boot/Image.lz4 ]; then
            cp build.log error.log
            echo "SUCCESS=0" >> $GITHUB_ENV
            exit 1
          fi

          echo "SUCCESS=1" >> $GITHUB_ENV

      - name: Detect kernel image
        if: env.SUCCESS == '1'
        run: |
          if [ -f out/arch/arm64/boot/Image.gz ]; then
            echo "KIMG=Image.gz" >> $GITHUB_ENV
          elif [ -f out/arch/arm64/boot/Image.lz4 ]; then
            echo "KIMG=Image.lz4" >> $GITHUB_ENV
          else
            echo "KIMG=Image" >> $GITHUB_ENV
          fi

      - name: Prepare AnyKernel3
        if: env.SUCCESS == '1'
        run: |
          rm -rf anykernel
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3 anykernel
          cp out/arch/arm64/boot/${KIMG} anykernel/

          sed -i "s|kernel.string=.*|kernel.string=Kernel-${DEVICE}|" anykernel/anykernel.sh
          sed -i "s|device.name=.*|device.name=${DEVICE}|" anykernel/anykernel.sh

      - name: Zip kernel
        if: env.SUCCESS == '1'
        run: |
          cd anykernel
          zip -r Kernel-${DEVICE}.zip *
          mv Kernel-${DEVICE}.zip ..

      # âœ… FIXED â€” success message formatting
      - name: Telegram success
        if: env.SUCCESS == '1'
        run: |
          KVER=$(strings out/arch/arm64/boot/${KIMG} | grep "Linux version" | head -n1)

          MSG=$(cat <<EOF
âœ… Kernel Build Success
ðŸ“± Device: ${DEVICE}
ðŸ§  Type: ${KERNEL_TYPE}
ðŸ›  ${KVER}
â± Build Time: ${BUILD_TIME}s
ðŸ“¦ ZIP + build.log sent below
EOF
          )

          curl -s -X POST https://api.telegram.org/bot${TG_TOKEN}/sendMessage \
            -d chat_id="${TG_CHAT_ID}" \
            --data-urlencode "text=${MSG}"

      - name: Telegram upload artifacts
        if: env.SUCCESS == '1'
        run: |
          curl -F document=@Kernel-${DEVICE}.zip https://api.telegram.org/bot${TG_TOKEN}/sendDocument?chat_id=${TG_CHAT_ID}
          curl -F document=@build.log https://api.telegram.org/bot${TG_TOKEN}/sendDocument?chat_id=${TG_CHAT_ID}

      - name: Telegram failure
        if: failure()
        run: |
          MSG=$(cat <<EOF
âŒ Kernel Build Failed
ðŸ“± Device: ${DEVICE}
ðŸ“„ error.log attached
EOF
          )

          curl -s -X POST https://api.telegram.org/bot${TG_TOKEN}/sendMessage \
            -d chat_id="${TG_CHAT_ID}" \
            --data-urlencode "text=${MSG}"

          curl -F document=@error.log https://api.telegram.org/bot${TG_TOKEN}/sendDocument?chat_id=${TG_CHAT_ID}
