name: Android Kernel CI

on:
  workflow_dispatch:
    inputs:
      device:
        description: Device codename (e.g. stone)
        required: true
      defconfig:
        description: Kernel defconfig (e.g. stone_defconfig)
        required: true
      kernel_source:
        description: Kernel source git link
        required: true
      kernel_branch:
        description: Kernel branch
        required: true

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      TG_TOKEN: ${{ secrets.TG_TOKEN }}
      TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}

    steps:
      - name: Checkout CI repo
        uses: actions/checkout@v4

      - name: Clone kernel source
        run: |
          git clone --depth=1 -b "${{ inputs.kernel_branch }}" \
            "${{ inputs.kernel_source }}" kernel

      # ---------- Telegram start ----------
      - name: Telegram build started
        run: |
          curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d "chat_id=${TG_CHAT_ID}" \
            -d "text=üöÄ Kernel build started | Device: ${{ inputs.device }} | Branch: ${{ inputs.kernel_branch }}"

      # ---------- Dependencies ----------
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            bc bison flex build-essential \
            libssl-dev libelf-dev \
            clang lld git curl

      # ---------- Build ----------
      - name: Build kernel
        run: |
          set -e
          cd kernel
          make O=out ARCH=arm64 ${{ inputs.defconfig }}
          make -j$(nproc) \
            O=out \
            ARCH=arm64 \
            CC=clang \
            LD=ld.lld \
            2>&1 | tee build.log

      # ---------- Kernel info ----------
      - name: Extract kernel info
        if: success()
        run: |
          cd kernel
          strings out/vmlinux | grep "Linux version" | head -n 1 > ../kernel_info.txt
          clang --version | head -n 1 >> ../kernel_info.txt

      # ---------- Success ----------
      - name: Telegram success message
        if: success()
        run: |
          INFO=$(cat kernel_info.txt)
          curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d "chat_id=${TG_CHAT_ID}" \
            -d "text=‚úÖ Kernel build SUCCESS | Device: ${{ inputs.device }} | ${INFO}"

      - name: Telegram upload Image
        if: success()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendDocument" \
            -F "chat_id=${TG_CHAT_ID}" \
            -F "document=@kernel/out/arch/arm64/boot/Image" \
            -F "caption=üì¶ Kernel Image"

      - name: Telegram upload build log
        if: success()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendDocument" \
            -F "chat_id=${TG_CHAT_ID}" \
            -F "document=@kernel/build.log" \
            -F "caption=üìÑ build.log"

      # ---------- Failure ----------
      - name: Telegram failure message
        if: failure()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d "chat_id=${TG_CHAT_ID}" \
            -d "text=‚ùå Kernel build FAILED | Device: ${{ inputs.device }}"

      - name: Telegram upload error log
        if: failure()
        run: |
          if [ -f kernel/build.log ]; then
            curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendDocument" \
              -F "chat_id=${TG_CHAT_ID}" \
              -F "document=@kernel/build.log" \
              -F "caption=‚ùÑÔ∏è error.log"
          fi
