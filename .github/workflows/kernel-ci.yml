name: Android Kernel CI

on:
  workflow_dispatch:
    inputs:
      codename:
        description: "Device codename (e.g. stone)"
        required: true
      defconfig:
        description: "Kernel defconfig (e.g. stone_defconfig)"
        required: true
      kernel_repo:
        description: "Kernel source git URL"
        required: true
      kernel_branch:
        description: "Kernel branch"
        required: true
      kernelsu_next:
        description: "Enable KernelSU-Next (true/false)"
        required: true
        default: "false"
      susfs:
        description: "Enable SUSFS (true/false)"
        required: true
        default: "false"

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      ARCH: arm64
      SUBARCH: arm64
      CC: clang
      LLVM: 1
      LLVM_IAS: 1
      KBUILD_BUILD_USER: CI
      KBUILD_BUILD_HOST: GitHub

    steps:
      - name: Checkout CI repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            bc bison build-essential ccache curl flex git \
            libssl-dev python3 zip unzip rsync dwarves

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1
        with:
          max-size: 10G

      - name: Restore Proton clang cache
        uses: actions/cache@v4
        with:
          path: clang
          key: proton-clang-r522817

      - name: Clone Proton Clang
        if: ${{ !exists('clang/bin/clang') }}
        run: |
          git clone --depth=1 https://github.com/kdrag0n/proton-clang clang

      - name: Export toolchain
        run: |
          echo "$GITHUB_WORKSPACE/clang/bin" >> $GITHUB_PATH

      - name: Clone kernel source
        run: |
          git clone --depth=1 \
            -b "${{ inputs.kernel_branch }}" \
            "${{ inputs.kernel_repo }}" kernel

      - name: KernelSU-Next integration
        if: inputs.kernelsu_next == 'true'
        run: |
          cd kernel
          curl -LSs https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh | bash -

      - name: SUSFS toggle
        if: inputs.susfs == 'true'
        run: |
          cd kernel
          scripts/config --enable CONFIG_KSU_SUSFS || true

      - name: Build kernel
        id: build
        run: |
          set -eo pipefail
          cd kernel

          mkdir -p out
          make O=out ${{ inputs.defconfig }}

          # vdso32 auto-disable
          if grep -q CONFIG_COMPAT_VDSO=y out/.config; then
            scripts/config --file out/.config \
              -d CONFIG_COMPAT_VDSO \
              -d CONFIG_VDSO32
            make O=out olddefconfig
          fi

          make -j$(nproc) O=out 2>&1 | tee build.log

      - name: Detect kernel type & info
        id: info
        run: |
          cd kernel
          VERSION=$(make kernelversion)
          if grep -q CONFIG_GKI=y out/.config; then
            TYPE=GKI
          else
            TYPE=NON-GKI
          fi
          CLANG_VER=$(clang --version | head -n1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "type=$TYPE" >> $GITHUB_OUTPUT
          echo "clang=$CLANG_VER" >> $GITHUB_OUTPUT

      - name: Prepare artifacts
        run: |
          mkdir artifacts
          cp kernel/build.log artifacts/

          IMAGE=$(find kernel/out/arch/arm64/boot -name Image | head -n1)
          cp "$IMAGE" artifacts/Image

      - name: AnyKernel3 packaging
        run: |
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3 anykernel
          cp artifacts/Image anykernel/
          sed -i "s/device.name=.*/device.name=${{ inputs.codename }}/" anykernel/anykernel.sh
          cd anykernel
          zip -r9 ../artifacts/AnyKernel-${{ inputs.codename }}.zip *

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ inputs.codename }}
          path: artifacts/*

      - name: Telegram SUCCESS
        if: success()
        run: |
          MSG="âœ… Kernel build successful\n\
ğŸ“± Device: ${{ inputs.codename }}\n\
ğŸ§  Type: ${{ steps.info.outputs.type }}\n\
ğŸ”¢ Kernel: ${{ steps.info.outputs.version }}\n\
ğŸ› ï¸ ${{ steps.info.outputs.clang }}"
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TG_CHAT_ID }} \
            -d text="$MSG"

      - name: Telegram FAILURE
        if: failure()
        run: |
          MSG="âŒ Kernel build failed\nğŸ“± Device: ${{ inputs.codename }}"
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TG_CHAT_ID }} \
            -d text="$MSG"
