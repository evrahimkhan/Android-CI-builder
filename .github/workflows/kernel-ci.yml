name: Android Kernel CI

on:
  workflow_dispatch:
    inputs:
      kernel_source:
        description: Kernel source git URL
        required: true
        type: string
      kernel_branch:
        description: Kernel branch
        required: true
        type: string
      device:
        description: Device codename (for naming only)
        required: true
        type: string
      defconfig:
        description: Kernel defconfig (e.g. vendor/moonstone_defconfig)
        required: true
        type: string
      kernelsu_next:
        description: Enable KernelSU-Next
        required: true
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    env:
      ARCH: arm64
      SUBARCH: arm64
      TG_TOKEN: ${{ secrets.TG_TOKEN }}
      TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
      CCACHE_DIR: ${{ github.workspace }}/.ccache

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive

      - name: Make CI scripts executable
        shell: bash
        run: |
          set -euo pipefail
          chmod +x ci/*.sh

      - name: Install dependencies
        shell: bash
        run: ci/install_deps.sh

      - name: Restore Proton Clang cache
        uses: actions/cache@v4
        with:
          path: clang
          key: proton-clang-v1

      - name: Setup Proton Clang
        shell: bash
        run: ci/setup_proton_clang.sh

      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-${{ runner.os }}-${{ inputs.kernel_branch }}-${{ inputs.defconfig }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ inputs.kernel_branch }}-${{ inputs.defconfig }}-
            ccache-${{ runner.os }}-

      - name: Clone Kernel Source
        shell: bash
        run: ci/clone_kernel.sh "${{ inputs.kernel_source }}" "${{ inputs.kernel_branch }}"

      - name: Apply KernelSU-Next
        if: ${{ inputs.kernelsu_next == 'true' }}
        shell: bash
        run: ci/apply_kernelsu_next.sh

      - name: Patch unsupported Polly flags
        shell: bash
        run: ci/patch_polly.sh

      - name: Telegram Build Start
        if: ${{ env.TG_TOKEN != '' && env.TG_CHAT_ID != '' }}
        shell: bash
        run: ci/telegram.sh start "${{ inputs.device }}" "${{ inputs.kernel_branch }}" "${{ inputs.defconfig }}" "${{ inputs.kernelsu_next }}"

      - name: Build Kernel
        shell: bash
        run: ci/build_kernel.sh "${{ inputs.defconfig }}" "${{ inputs.kernelsu_next }}"

      - name: Detect GKI
        shell: bash
        run: ci/detect_gki.sh

      - name: Ensure AnyKernel core exists
        if: env.SUCCESS == '1'
        shell: bash
        run: ci/ensure_anykernel_core.sh

      - name: Package AnyKernel3
        if: env.SUCCESS == '1'
        shell: bash
        run: ci/package_anykernel.sh "${{ inputs.device }}"

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: kernel-${{ inputs.device }}-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            Kernel-*.zip
            kernel/build.log
            kernel/error.log
          if-no-files-found: warn

      - name: GitHub Release
        if: env.SUCCESS == '1'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.run_id }}-${{ github.run_attempt }}
          name: Kernel-${{ inputs.device }} (run ${{ github.run_id }}/${{ github.run_attempt }})
          files: |
            ${{ env.ZIP_NAME }}
            kernel/build.log

      - name: Telegram Success
        if: ${{ env.SUCCESS == '1' && env.TG_TOKEN != '' && env.TG_CHAT_ID != '' }}
        shell: bash
        run: ci/telegram.sh success "${{ inputs.device }}" "${{ inputs.kernelsu_next }}"

      - name: Telegram Failure
        if: ${{ env.SUCCESS == '0' && env.TG_TOKEN != '' && env.TG_CHAT_ID != '' }}
        shell: bash
        run: ci/telegram.sh failure "${{ inputs.device }}" "${{ inputs.kernelsu_next }}"

      - name: Mark workflow failed if kernel build failed
        if: env.SUCCESS == '0'
        shell: bash
        run: exit 1
