name: Android Kernel CI Builder

on:
  workflow_dispatch:
    inputs:
      devicename:
        description: "Device codename"
        required: true
      defconfig:
        description: "Kernel defconfig"
        required: true
      kernel_repo:
        description: "Kernel source repo"
        required: true
      kernel_branch:
        description: "Kernel branch"
        required: true
        default: "main"
      anykernel_repo:
        description: "AnyKernel3 repo"
        required: true
      kernelsu:
        description: "Enable KernelSU-Next (true/false)"
        required: true
        default: "false"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # ---------------- CHECKOUT ----------------
      - name: Checkout CI repo
        uses: actions/checkout@v4

      # ---------------- DEPENDENCIES ----------------
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            bc bison build-essential flex git gperf \
            libncurses-dev libssl-dev libelf-dev lzop \
            python3 unzip zip wget curl \
            gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu \
            gcc-arm-linux-gnueabi binutils-arm-linux-gnueabi \
            gcc-arm-linux-gnueabihf binutils-arm-linux-gnueabihf

      # ---------------- CLANG ----------------
      - name: Setup clang
        run: |
          chmod +x Common/clang.sh
          bash Common/clang.sh

      # ---------------- KERNEL ----------------
      - name: Clone kernel source
        run: |
          git clone --depth=1 \
            -b ${{ inputs.kernel_branch }} \
            ${{ inputs.kernel_repo }} kernel

      # ---------------- KernelSU-Next ----------------
      - name: Integrate KernelSU-Next
        if: ${{ inputs.kernelsu == 'true' }}
        run: |
          cd kernel
          curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh" | bash -

      # ---------------- AUTO VDSO32 DETECT ----------------
      - name: Detect vdso32 support
        run: |
          cd kernel
          if grep -R "CONFIG_COMPAT_VDSO=y" arch/arm64/configs/${{ inputs.defconfig }} 2>/dev/null; then
            echo "VDSO32_SUPPORTED=true" >> $GITHUB_ENV
          else
            echo "VDSO32_SUPPORTED=false" >> $GITHUB_ENV
          fi

      # ---------------- BUILD ----------------
      - name: Build kernel
        run: |
          set -o pipefail

          export ARCH=arm64
          export SUBARCH=arm64
          export PATH=$PWD/clang/bin:$PATH

          export CC=clang
          export HOSTCC=clang

          export CROSS_COMPILE=aarch64-linux-gnu-
          export CROSS_COMPILE_ARM32=arm-linux-gnueabi-

          # ---- FIX OPTION 2 (vdso32 safe)
          export LD=aarch64-linux-gnu-ld
          export LD32=arm-linux-gnueabi-ld

          cd kernel

          make O=out ${{ inputs.defconfig }}

          # ---- Disable vdso32 ONLY if unsupported AND tool exists
          if [ "$VDSO32_SUPPORTED" = "false" ] && [ -x scripts/config ]; then
            echo "Disabling CONFIG_COMPAT_VDSO"
            scripts/config --file out/.config -d CONFIG_COMPAT_VDSO || true
            make O=out olddefconfig
          fi

          # ---- MAIN BUILD (never silently fail)
          make -j$(nproc) O=out \
            CC=clang \
            HOSTCC=clang \
            CROSS_COMPILE=aarch64-linux-gnu- \
            CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
            2>&1 | tee ../build.log || true

          # ---- REAL ERROR DETECT
          if grep -i "error:" ../build.log; then
            cp ../build.log ../error.log
            exit 1
          fi

      # ---------------- ANYKERNEL ZIP ----------------
      - name: Build flashable ZIP
        if: success()
        run: |
          git clone --depth=1 ${{ inputs.anykernel_repo }} AnyKernel
          cp kernel/out/arch/arm64/boot/Image AnyKernel/

          ZIPNAME="${{ inputs.devicename }}-kernel-${GITHUB_RUN_NUMBER}.zip"
          cd AnyKernel
          zip -r "../$ZIPNAME" ./*
          echo "ZIPNAME=$ZIPNAME" >> $GITHUB_ENV

      # ---------------- ARTIFACTS ----------------
      - name: Upload ZIP
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: kernel-zip
          path: "*.zip"

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log

      - name: Upload error log
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-log
          path: error.log

      # ---------------- TELEGRAM ----------------
      - name: Telegram notification
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            STATUS="✅ BUILD SUCCESS"
          else
            STATUS="❌ BUILD FAILED"
          fi

          RUN_URL="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"

          TEXT=$(printf "Android Kernel CI\nDevice: %s\nKernelSU-Next: %s\nStatus: %s" \
            "${{ inputs.devicename }}" \
            "${{ inputs.kernelsu }}" \
            "$STATUS")

          BUTTONS=$(printf '{"inline_keyboard":[[{"text":"⬇ Download","url":"%s"}]]}' \
            "$RUN_URL")

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TG_CHAT_ID }}" \
            -d text="$TEXT" \
            -d reply_markup="$BUTTONS"
