name: Android Kernel CI

on:
  workflow_dispatch:
    inputs:
      CODENAME:
        description: "Device codename (e.g. moonstone)"
        required: true
      DEFCONFIG:
        description: "Kernel defconfig (e.g. vendor/moonstone_defconfig)"
        required: true
      KERNEL_REPO:
        description: "Kernel source repo URL"
        required: true
      KERNEL_BRANCH:
        description: "Kernel branch"
        required: true
      ENABLE_KSU:
        description: "Enable KernelSU-Next (true/false)"
        required: true
        default: "false"
      ENABLE_SUSFS:
        description: "Enable SUSFS (true/false)"
        required: true
        default: "false"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout CI repo
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          bc bison build-essential curl flex git \
          libssl-dev libelf-dev lld llvm \
          python3 unzip zip

    # =======================
    # üîß Proton Clang (ONLY)
    # =======================
    - name: Setup Proton Clang
      uses: actions/cache@v4
      with:
        path: clang
        key: proton-clang

    - name: Clone Proton Clang
      run: |
        if [ ! -d clang/bin ]; then
          git clone --depth=1 https://github.com/kdrag0n/proton-clang.git clang
        fi
        echo "PATH=$PWD/clang/bin:$PATH" >> $GITHUB_ENV

    # =======================
    # üì• Kernel source
    # =======================
    - name: Clone kernel source
      run: |
        git clone --depth=1 \
          -b ${{ inputs.KERNEL_BRANCH }} \
          ${{ inputs.KERNEL_REPO }} kernel

    # =======================
    # üîê KernelSU-Next
    # =======================
    - name: Setup KernelSU-Next
      if: inputs.ENABLE_KSU == 'true'
      run: |
        cd kernel
        curl -LSs https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/next/kernel/setup.sh | bash -

    # =======================
    # ‚öôÔ∏è Kernel config
    # =======================
    - name: Configure kernel
      run: |
        set -o pipefail
        cd kernel
        export ARCH=arm64
        export CC=clang
        export LLVM=1
        export LLVM_IAS=1

        mkdir -p out
        make O=out ${{ inputs.DEFCONFIG }}

        # vdso32 auto-disable (arm32 linker fix)
        if grep -q CONFIG_COMPAT_VDSO=y out/.config; then
          echo "‚ö†Ô∏è COMPAT_VDSO detected, disabling vdso32"
          scripts/config --file out/.config \
            -d CONFIG_COMPAT_VDSO \
            -d CONFIG_VDSO32
          make O=out olddefconfig
        fi

    # =======================
    # üèóÔ∏è Build kernel
    # =======================
    - name: Build kernel
      run: |
        set -o pipefail
        cd kernel
        make O=out -j$(nproc) 2>&1 | tee build.log

    # =======================
    # üß† GKI detect
    # =======================
    - name: Detect GKI
      run: |
        cd kernel
        if grep -q "GKI" out/include/generated/utsrelease.h; then
          echo "GKI=true" >> $GITHUB_ENV
        else
          echo "GKI=false" >> $GITHUB_ENV
        fi

    # =======================
    # üõ†Ô∏è AOSP mkbootimg
    # =======================
    - name: Setup mkbootimg
      run: |
        git clone https://android.googlesource.com/platform/system/tools/mkbootimg tools/mkbootimg
        chmod +x tools/mkbootimg/mkbootimg.py

    - name: Build boot.img
      run: |
        cd kernel
        python3 ../tools/mkbootimg/mkbootimg.py \
          --kernel out/arch/arm64/boot/Image \
          --header_version 3 \
          --os_version 13.0.0 \
          --os_patch_level 2023-01 \
          --output boot.img

    # =======================
    # üì¶ AnyKernel3
    # =======================
    - name: Package AnyKernel3
      run: |
        git clone https://github.com/osm0sis/AnyKernel3.git ak3
        cp kernel/out/arch/arm64/boot/Image ak3/
        cd ak3
        zip -r ../Kernel-${{ inputs.CODENAME }}.zip *

    # =======================
    # üì§ Upload artifacts
    # =======================
    - name: Upload kernel ZIP
      uses: actions/upload-artifact@v4
      with:
        name: Kernel-${{ inputs.CODENAME }}
        path: Kernel-${{ inputs.CODENAME }}.zip

    - name: Upload boot.img
      uses: actions/upload-artifact@v4
      with:
        name: boot.img
        path: kernel/boot.img

    # =======================
    # ‚ùå Error log
    # =======================
    - name: Upload error log
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: error.log
        path: kernel/build.log
